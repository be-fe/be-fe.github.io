<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Electron在企业云盘中的应用 | 百度EUX </title>
    <link rel="stylesheet" href="/style.css">
    <script>
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?d232748d06c1fe09a6db3db0077669b7";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();

      var _vds = _vds || [];
      window._vds = _vds;
      (function () {
        _vds.push(['setAccountId', '66707fb8b27442d5b3ccca57a56800fa']);
        _vds.push(['trackBot', false]);

        (function () {
          var vds = document.createElement('script');
          vds.type = 'text/javascript';
          vds.async = true;
          vds.src = '//dn-growing.qbox.me/vds.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(vds, s);
        })();
      })();
    </script>
</head>
<body>
<div id="root">
    <div class="main" data-reactroot="" data-reactid="1" data-react-checksum="-907573695"><!-- react-empty: 2 --><header class="eux-header clearfix" data-reactid="3"><div class="eux-header-top" data-reactid="4"><a href="javascript:void(0);" class="eux-portable-menu" data-reactid="5"><span data-reactid="6"></span><span data-reactid="7"></span><span data-reactid="8"></span></a><!-- react-empty: 9 --><nav class="menu-primary-container" data-reactid="10"><ul id="menu-primary" class="menu" data-reactid="11"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-25" data-reactid="12"><a href="/" data-reactid="13">HOME</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom current-menu-ancestor current-menu-parent menu-item-has-children menu-item-45" data-reactid="14"><a href="/" data-reactid="15">BLOG</a><ul class="sub-menu" data-reactid="16"><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-menu-item menu-item-63" data-reactid="17"><a href="/ue" data-reactid="18">交互</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-menu-item menu-item-63" data-reactid="19"><a href="/ui" data-reactid="20">视觉</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-menu-item menu-item-63" data-reactid="21"><a href="/fe" data-reactid="22">前端</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-menu-item menu-item-63" data-reactid="23"><a href="/team" data-reactid="24">团队</a></li></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-46" data-reactid="25"><a href="/tools" data-reactid="26">TOOLS</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-112" data-reactid="27"><a href="/works" data-reactid="28">WORKS</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-138" data-reactid="29"><a href="/jobs" data-reactid="30">JOBS</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-50" data-reactid="31"><a href="/about-us" data-reactid="32">ABOUT US</a></li></ul></nav></div></header><div class="eux-singular clearfix" data-reactid="33"><div class="container-singular clearfix" data-reactid="34"><nav class="menu-categories-container" data-reactid="35"><ul id="menu-categories" class="menu" data-reactid="36"><li class="menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="37"><span data-reactid="38"><a href="/" data-reactid="39">全部</a></span></li><li class="menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="40"><span data-reactid="41"><a href="/ue" data-reactid="42">交互</a></span></li><li class="menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="43"><span data-reactid="44"><a href="/ui" data-reactid="45">视觉</a></span></li><li class="current-menu-item menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="46"><span data-reactid="47"><a href="/fe" data-reactid="48">前端</a></span></li><li class="menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="49"><span data-reactid="50"><a href="/team" data-reactid="51">团队</a></span></li></ul></nav><div class="inner clearfix" data-reactid="52"><div class="article-meta" data-reactid="53"><h1 class="title" data-reactid="54">Electron在企业云盘中的应用</h1><div class="eux-page-detail" data-reactid="55"><span data-reactid="56"><em data-reactid="57">by.</em><!-- react-text: 58 -->刘, 卉<!-- /react-text --></span><span data-reactid="59">2017-6-6</span></div></div><article data-reactid="60"><h1 id="简要介绍" data-reactid="61"><a href="#%E7%AE%80%E8%A6%81%E4%BB%8B%E7%BB%8D" aria-hidden="true" data-reactid="62"><span class="icon icon-link" data-reactid="63"></span></a><!-- react-text: 64 -->简要介绍<!-- /react-text --></h1><ul data-reactid="65"><li data-reactid="66">Electron是一个可以使用js、html、css创建桌面应用的库</li><li data-reactid="67">可以创建mac、window、linux等应用</li><li data-reactid="68">atom基于electron开发，以前叫atom-shell</li></ul><p data-reactid="69"><a href="http://ww1.sinaimg.cn/large/bdab2ccely1fjjannpuzoj216s0gg780.jpg" data-reactid="70"><img src="http://ww1.sinaimg.cn/large/bdab2ccely1fjjannpuzoj216s0gg780.jpg" alt="alt" width="1540" height="592" data-reactid="71"/></a></p><h1 id="如何开发你的desktop应用" data-reactid="72"><a href="#%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E4%BD%A0%E7%9A%84desktop%E5%BA%94%E7%94%A8" aria-hidden="true" data-reactid="73"><span class="icon icon-link" data-reactid="74"></span></a><!-- react-text: 75 -->如何开发你的desktop应用<!-- /react-text --></h1><ul data-reactid="76"><li data-reactid="77">一个简单的 demo</li></ul><p data-reactid="78"><a href="https://github.com/sindresorhus/electron-boilerplate/tree/master/boilerplate" data-reactid="79">demo</a></p><ul data-reactid="80"><li data-reactid="81">一个入口main.js（mainProcess）+ 一个index.html（renderProcess）</li><li data-reactid="82">执行 electron main.js</li></ul><h1 id="企业云盘的整体结构" data-reactid="83"><a href="#%E4%BC%81%E4%B8%9A%E4%BA%91%E7%9B%98%E7%9A%84%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84" aria-hidden="true" data-reactid="84"><span class="icon icon-link" data-reactid="85"></span></a><!-- react-text: 86 -->企业云盘的整体结构<!-- /react-text --></h1><pre data-reactid="87"><code data-query="{}" data-lang="data-lang" data-reactid="88">├── build(app打包资源)
├── readme.md
├── release(发布路径)
├── renderProcess（渲染进程）
├── mainProcess（主进程）
├── plugin(插件)
├── certs(证书)
├── build.sh(自动发版脚本)
├── config.js(全局配置项)
├── package.json
└── windowinstall.js（window安装包生成脚本）
</code></pre><ul data-reactid="89"><li data-reactid="90">整体的结构就是按照两个进程来划分</li><li data-reactid="91">renderProcess中可以使用任何你想用的架构，企业云盘采用的是react+redux+router结构</li><li data-reactid="92">企业云盘开发环境中采用localhost:3000的实时编译调试模式，发包时采用file协议</li></ul><h3 id="mainproces" data-reactid="93"><a href="#mainproces" aria-hidden="true" data-reactid="94"><span class="icon icon-link" data-reactid="95"></span></a><!-- react-text: 96 -->mainProces:<!-- /react-text --></h3><h4 id="数据库采用nodejs库-nedbmainprocessdatabase" data-reactid="97"><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%87%87%E7%94%A8nodejs%E5%BA%93-nedbmainprocessdatabase" aria-hidden="true" data-reactid="98"><span class="icon icon-link" data-reactid="99"></span></a><!-- react-text: 100 -->数据库采用nodejs库 nedb(mainProcess/database)<!-- /react-text --></h4><p data-reactid="101">数据文件存储在应用数据下的.clouddiskdata，刚开始采用的是mongodb,后来打包发现太大，多40多M，还卡</p><pre data-reactid="102"><code data-query="{}" data-lang="data-lang" data-reactid="103">let Datastore = require(&#x27;nedb&#x27;);
let db = new Datastore({ filename: &#x27;path/to/datafile&#x27; });
db.loadDatabase(function (err) {    // Callback is optional
  // Now commands will be executed
});
</code></pre><p data-reactid="104">注意nedb为了保证数据的持久性，每一次update或者delete操作实际上都是在最后一行添加一条数据，但是每次load database的时候，会自动合并所有的数据项，所以云盘里面可以看到每次update都调用了</p><p data-reactid="105">db.loadDatabase();</p><p data-reactid="106">官方解释如下：</p><p data-reactid="107">Under the hood, NeDB’s persistence uses an append-only format, meaning that all updates and deletes actually result in lines added at the end of the datafile, for performance reasons. The database is automatically compacted (i.e. put back in the one-line-per-document format) every time you load each database within your application.</p><p data-reactid="108"><a href="https://github.com/louischatriot/nedb" data-reactid="109">官网</a></p><h4 id="登录认证-mainprocessuuap" data-reactid="110"><a href="#%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81-mainprocessuuap" aria-hidden="true" data-reactid="111"><span class="icon icon-link" data-reactid="112"></span></a><!-- react-text: 113 -->登录认证 (mainProcess/uuap)<!-- /react-text --></h4><p data-reactid="114">浏览器向server发起请求,server端进行登录，并且在head中set-cookie</p><p data-reactid="115">mainProcess通过该有效cookie发起后续所有请求</p><p data-reactid="116">renderProcess中的请求通过ipc通信方式使用nodejs的request模块来进行通信</p><h4 id="浏览器中直接调起客户端，urlschememainprocessurlprotocol" data-reactid="117"><a href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E7%9B%B4%E6%8E%A5%E8%B0%83%E8%B5%B7%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%8Curlschememainprocessurlprotocol" aria-hidden="true" data-reactid="118"><span class="icon icon-link" data-reactid="119"></span></a><!-- react-text: 120 -->浏览器中直接调起客户端，urlScheme(mainProcess/urlProtocol)<!-- /react-text --></h4><p data-reactid="121">1.浏览器端</p><p data-reactid="122"><a href="/ecloud-baidu://open" data-reactid="123">添加备份</a></p><pre data-reactid="124"><code data-query="{}" data-lang="data-lang" data-reactid="125"></code></pre><p data-reactid="126">2.mainProcess代码如下</p><p data-reactid="127"><a href="http://eux.baidu.com/wp-content/uploads/2017/06/28.md0uZGp9DO.png" data-reactid="128"><img src="http://eux.baidu.com/wp-content/uploads/2017/06/28.md0uZGp9DO.png" data-reactid="129"/></a></p><p data-reactid="130">3.配置info.plist</p><p data-reactid="131"><a href="http://eux.baidu.com/wp-content/uploads/2017/06/28.mdFssiOOjv.png" data-reactid="132"><img src="http://eux.baidu.com/wp-content/uploads/2017/06/28.mdFssiOOjv.png" data-reactid="133"/></a></p><p data-reactid="134">4.打包过程中也需要配置下，否则mac中不生效</p><p data-reactid="135"><a href="http://ww1.sinaimg.cn/large/bdab2ccely1fjjapd8obnj20l406ead5.jpg" data-reactid="136"><img src="http://ww1.sinaimg.cn/large/bdab2ccely1fjjapd8obnj20l406ead5.jpg" alt="alt" width="760" height="230" data-reactid="137"/></a></p><h4 id="窗口管理器（mainprocesswindowmanage）" data-reactid="138"><a href="#%E7%AA%97%E5%8F%A3%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%88mainprocesswindowmanage%EF%BC%89" aria-hidden="true" data-reactid="139"><span class="icon icon-link" data-reactid="140"></span></a><!-- react-text: 141 -->窗口管理器（mainProcess/windowManage）<!-- /react-text --></h4><pre data-reactid="142"><code data-query="{}" data-lang="data-lang" data-reactid="143">1.企业云盘总共有三个window（主页、设置页、预览页、反馈页、二次确认页）   
</code></pre><h4 id="traymenu控制（mainprocesstraymenu）" data-reactid="144"><a href="#traymenu%E6%8E%A7%E5%88%B6%EF%BC%88mainprocesstraymenu%EF%BC%89" aria-hidden="true" data-reactid="145"><span class="icon icon-link" data-reactid="146"></span></a><!-- react-text: 147 -->traymenu控制（mainProcess/trayMenu）<!-- /react-text --></h4><p data-reactid="148">参考官方api写即可，大致代码如下：</p><pre data-reactid="149"><code data-query="{}" data-lang="data-lang" data-reactid="150">const contextMenu = Menu.buildFromTemplate([
    {
        label: &#x27;访问网页版&#x27;,
        click: () =&gt; {
            shell.openExternal(&#x27;http://ecloud.baidu.com&#x27;)
        }
    }, {
        label: &#x27;反馈&#x27;,
        click: (e) =&gt; {
            renderFeedBack(1);
        }
    }, {
        label: &#x27;设置&#x27;,
        click: (e) =&gt; {
            renderSettingWindow(1);

        }
    }, {
        label: &#x27;退出&#x27;,
        click: () =&gt; {
            app.quit();
        }
    }
])
</code></pre><p data-reactid="151"><a href="http://ww1.sinaimg.cn/large/bdab2ccely1fjjapsyh6dj20c2072jt3.jpg" data-reactid="152"><img src="http://ww1.sinaimg.cn/large/bdab2ccely1fjjapsyh6dj20c2072jt3.jpg" alt="alt" width="434" height="254" data-reactid="153"/></a></p><h4 id="传输控制（mainprocesstransfile-、-mainprocesswatcher）" data-reactid="154"><a href="#%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%EF%BC%88mainprocesstransfile-%E3%80%81-mainprocesswatcher%EF%BC%89" aria-hidden="true" data-reactid="155"><span class="icon icon-link" data-reactid="156"></span></a><!-- react-text: 157 -->传输控制（mainProcess/transfile 、 mainProcess/watcher）<!-- /react-text --></h4><p data-reactid="158">本地文件增删改查检测（使用nodejs库chokidar，目前mac已迁移到Object-c的app中）</p><p data-reactid="159">关于electron中与oc app的通信方式。目前采用的是shell里面的open命令，以及web server方式</p><p data-reactid="160">mainProcess中创建webserver服务，oc中通过发起http请求进行通信</p><p data-reactid="161">mainProcess和oc通信采用open方式</p><p data-reactid="162">云盘接受oc的web服务</p><pre data-reactid="163"><code data-query="{}" data-lang="data-lang" data-reactid="164">let server = http.createServer(function (request, response) { 

        //.....
        /*前端需要备份的文件*/
        if (urlObj.pathname === &#x27;/set/file&#x27;) {
            response.end(&#x27;end&#x27;);
            
        }
        /*获取我的备份下需要备份的根目录或者文件*/
        if (urlObj.pathname === &#x27;/get/rootpath&#x27;) {
        }
}).listen(8887);
        //.......
</code></pre><p data-reactid="165">md5计算，采用md5-file</p><pre data-reactid="166"><code data-query="{}" data-lang="data-lang" data-reactid="167">let execSync = require(&#x27;child_process&#x27;).execSync;
execSync(&#x27;open ecloud-sync-backup-file.app&#x27;, {
    cwd: `${config.projectPath}/mainProcess/watcher/OC/ecloud-sync-backup-file`
})
</code></pre><p data-reactid="168">分片：</p><pre data-reactid="169"><code data-query="{}" data-lang="data-lang" data-reactid="170">fs.createReadStream(filePath, {
    start : i * limit,
    end   : (i * limit + limit - 1) &gt; lastByte? lastByte: i * limit + limit - 1
}
</code></pre><h4 id="系统通知：" data-reactid="171"><a href="#%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5%EF%BC%9A" aria-hidden="true" data-reactid="172"><span class="icon icon-link" data-reactid="173"></span></a><!-- react-text: 174 -->系统通知：<!-- /react-text --></h4><p data-reactid="175"><!-- react-text: 176 -->mac采用 <!-- /react-text --><a href="https://developer.mozilla.org/en-US/docs/Web/API/notification" data-reactid="177">notification</a></p><p data-reactid="178">window采用nodejs的node-notifier模块</p><h4 id="自动更新客户端（mainprocesscheckupdate）" data-reactid="179"><a href="#%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%88mainprocesscheckupdate%EF%BC%89" aria-hidden="true" data-reactid="180"><span class="icon icon-link" data-reactid="181"></span></a><!-- react-text: 182 -->自动更新客户端（mainProcess/checkUpdate）<!-- /react-text --></h4><p data-reactid="183"><a href="https://electron.atom.io/docs/api/auto-updater/" data-reactid="184">官方文档</a></p><p data-reactid="185">官方提供了几个自动更新的项目，nuts/electron-release-server/squirrel-updates-server/squirrel-release-server,这几个项目中其中2个都是采用github来进行发布，不符合我国国情</p><p data-reactid="186">企业云采用了electron-release-server这个项目来搭建自动升级服务</p><ul data-reactid="187"><li data-reactid="188">基于docker-compose</li></ul><ul data-reactid="189"><li data-reactid="190"><!-- react-text: 191 -->中间遇到的坑，这个项目基于docker-composer 的version2 版本，最低要求docker的版本为1.9.1以上，具体可参考 <!-- /react-text --><a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#args" data-reactid="192">https://docs.docker.com/compose/compose-file/compose-file-v2/#args</a></li><li data-reactid="193">最后采用了ubuntu的服务器，centos版本都太低</li><li data-reactid="194">开源项目里面需要简单的配置下数据库、服务器、修改资源存储的路径为永久存储</li><li data-reactid="195">公司的服务器的端口必须是8000以上，刚开始设置了个5555 怎么都不好使，能ping通，但是浏览器没法访问</li></ul><ul data-reactid="196"><li data-reactid="197">包含了资源存储</li><li data-reactid="198">强大的api支持</li><li data-reactid="199">使用Squirrel来模块来完成自动升级</li></ul><ul data-reactid="200"><li data-reactid="201">mac使用.dmg和.zip</li><li data-reactid="202">window 使用.exe .nupkg</li></ul><p data-reactid="203">关于自动更新中必须要注意的几个点：</p><ul data-reactid="204"><li data-reactid="205">必须要有证书</li></ul><ul data-reactid="206"><li data-reactid="207"><!-- react-text: 208 -->mac通过开发者账号生成,公司苹果开发者团队，可以通过权限申请加入，地址：<!-- /react-text --><a href="http://appdev.baidu.com/" data-reactid="209">http://appdev.baidu.com/</a></li></ul><p data-reactid="210"><a href="http://ww1.sinaimg.cn/large/bdab2ccely1fjjaqgp9f1j20do0amdit.jpg" data-reactid="211"><img src="http://ww1.sinaimg.cn/large/bdab2ccely1fjjaqgp9f1j20do0amdit.jpg" alt="alt" width="492" height="382" data-reactid="212"/></a></p><ul data-reactid="213"><li data-reactid="214">window证书</li></ul><p data-reactid="215"><!-- react-text: 216 -->ecloud.pfx,带秘钥的证书，具体可以参考 <!-- /react-text --><a href="https://www.npmjs.com/package/electron-installer-windows" data-reactid="217">如何生成pfx的证书</a></p><ul data-reactid="218"><li data-reactid="219"><!-- react-text: 220 -->具体方案可以参考 <!-- /react-text --><a href="https://medium.com/@svilen/auto-updating-apps-for-windows-and-osx-using-electron-the-complete-guide-4aa7a50b904c" data-reactid="221">Auto-updating apps for Windows and OSX using Electron: The complete guide</a></li><li data-reactid="222">自动更新提示如下</li></ul><p data-reactid="223"><a href="http://ww1.sinaimg.cn/large/bdab2ccely1fjjaqw909ij21a20i0wkm.jpg" data-reactid="224"><img src="http://ww1.sinaimg.cn/large/bdab2ccely1fjjaqw909ij21a20i0wkm.jpg" alt="alt" width="1658" height="648" data-reactid="225"/></a></p><p data-reactid="226"><a href="http://ww1.sinaimg.cn/large/bdab2ccely1fjjar8dcv5j20k009c77w.jpg" data-reactid="227"><img src="http://ww1.sinaimg.cn/large/bdab2ccely1fjjar8dcv5j20k009c77w.jpg" alt="alt" width="720" height="336" data-reactid="228"/></a></p><ul data-reactid="229"><li data-reactid="230">遇到坑</li></ul><p data-reactid="231">mac中autoUpdater.quitAndInstall(); 没有自动重启应用</p><p data-reactid="232">可以通过</p><p data-reactid="233">/Users/liuhui/Library/Caches/com.electron.ecloud.ShipIt下的</p><p data-reactid="234">ShipIt_stderr.log来查看问题所在</p><p data-reactid="235"><!-- react-text: 236 -->window中采用squirrel安装方式后很多问题，安装过程中应用就被打开，需要处理下squirrel事件,可以参考 <!-- /react-text --><a href="https://github.com/electron/windows-installer" data-reactid="237">https://github.com/electron/windows-installer</a></p><h4 id="flash的支持" data-reactid="238"><a href="#flash%E7%9A%84%E6%94%AF%E6%8C%81" aria-hidden="true" data-reactid="239"><span class="icon icon-link" data-reactid="240"></span></a><!-- react-text: 241 -->flash的支持<!-- /react-text --></h4><p data-reactid="242">需要添加pepper flash插件，Pepper Flash Player 是由Google维护的专用于chromium引擎的flash播放器</p><p data-reactid="243">首先是在自己电脑上找到pepper flash的插件（mac及window版本）</p><p data-reactid="244">结果如下：</p><p data-reactid="245">• 如果你有安装Chrome浏览器，可以在地址栏输入chrome://plugins/，点击右侧的详细信息，找到Adobe Flash Player条目,目前chrome已经废弃掉chrome://plugins/地址</p><p data-reactid="246">• 实际mac地址：/Library/Internet Plug-Ins/PepperFlashPlayer/PepperFlashPlayer.plugin</p><p data-reactid="247">window地址：C:\Windows\System32\Macromed\Flash\pepflashplayer64_24_0_0_194.dll(名称和版本号可能有出入) 重命名为pepflashplayer.dll即可。</p><p data-reactid="248">中间遇到的坑：</p><ul data-reactid="249"><li data-reactid="250">window上不好使，提示“无法加载插件”，确定为pepflashplayer64_24_0_0_194.dll的问题，去网上下载了一个</li><li data-reactid="251">chrome 53里面的flash有个闪烁的bug，浏览器bug，需要升级chrome版本</li></ul><p data-reactid="252">pepper flash引入</p><pre data-reactid="253"><code data-query="{}" data-lang="data-lang" data-reactid="254">let pluginName;
switch (process.platform) {
  case &#x27;win32&#x27;:
    pluginName = &#x27;pepflashplayer.dll&#x27;
    break
  case &#x27;darwin&#x27;:
    pluginName = &#x27;PepperFlashPlayer.plugin&#x27;
    break
  case &#x27;linux&#x27;:
    pluginName = &#x27;libpepflashplayer.so&#x27;
    break
}
app.commandLine.appendSwitch(&#x27;ppapi-flash-path&#x27;, path.join(__dirname+&#x27;/plugins/&#x27;, pluginName))
</code></pre><h4 id="网络检测mainprocessnetwork" data-reactid="255"><a href="#%E7%BD%91%E7%BB%9C%E6%A3%80%E6%B5%8Bmainprocessnetwork" aria-hidden="true" data-reactid="256"><span class="icon icon-link" data-reactid="257"></span></a><!-- react-text: 258 -->网络检测(mainProcess/network)<!-- /react-text --></h4><p data-reactid="259"><!-- react-text: 260 -->网络监测刚开始采用的 <!-- /react-text --><a href="https://developer.mozilla.org/en-US/docs/Online_and_offline_events" data-reactid="261">https://developer.mozilla.org/en-US/docs/Online_and_offline_events</a></p><p data-reactid="262">监测很准确，这种检测仅仅针对lan是否有连接，实际情况是很多时候网络是连着的，但是不能上网</p><p data-reactid="263">后面换成nodejs的方案</p><h3 id="renderprocess" data-reactid="264"><a href="#renderprocess" aria-hidden="true" data-reactid="265"><span class="icon icon-link" data-reactid="266"></span></a><!-- react-text: 267 -->renderProcess<!-- /react-text --></h3><pre data-reactid="268"><code data-query="{}" data-lang="data-lang" data-reactid="269">├── bin
│   ├── compile.js
│   └── server.js
├── build
│   ├── dll
│   ├── package.json
│   ├── webpack-compiler.js
│   ├── webpack.config.js
│   └── webpack.dll.config.js
├── config
│   └── index.js
├── package.json
├── server
│   └── main.js
└── src
    ├── components 组件
    ├── containers 容器
    ├── index.html 入口html
    ├── ipcCenter.js 消息中心
    ├── layouts 布局
    ├── main.js 入口js
    ├── routes 路由
    ├── static 静态js
    ├── statichtml 其他入口html
    ├── store 通用的store
    └── styles 样式
</code></pre><h3 id="两个进程" data-reactid="270"><a href="#%E4%B8%A4%E4%B8%AA%E8%BF%9B%E7%A8%8B" aria-hidden="true" data-reactid="271"><span class="icon icon-link" data-reactid="272"></span></a><!-- react-text: 273 -->两个进程<!-- /react-text --></h3><p data-reactid="274"><a href="https://electron.atom.io/docs/" data-reactid="275">官方网站</a></p><ul data-reactid="276"><li data-reactid="277">electron合并了chromium和node.js</li><li data-reactid="278">提供了一系列的api进行native开发，例如file dialogs,notifications,icons更多</li></ul><h4 id="中间的坑：" data-reactid="279"><a href="#%E4%B8%AD%E9%97%B4%E7%9A%84%E5%9D%91%EF%BC%9A" aria-hidden="true" data-reactid="280"><span class="icon icon-link" data-reactid="281"></span></a><!-- react-text: 282 -->中间的坑：<!-- /react-text --></h4><ul data-reactid="283"><li data-reactid="284"><!-- react-text: 285 -->可以看到官方网站提供了mainProcess和renderProcess区分了接口，但是这两个api并不是完全独立的，renderProces提供的remote模块可以获取到mainProcess到所有的api，详细见接口 <!-- /react-text --><a href="https://electron.atom.io/docs/api/remote/" data-reactid="286">接口文档</a></li><li data-reactid="287">企业云盘在mainProcess里面定义了整个app通用的全局变量：</li></ul><p data-reactid="288"><a href="http://ww1.sinaimg.cn/large/bdab2ccely1fjjarqtk6ej20fe0ac0x4.jpg" data-reactid="289"><img src="http://ww1.sinaimg.cn/large/bdab2ccely1fjjarqtk6ej20fe0ac0x4.jpg" alt="alt" width="554" height="372" data-reactid="290"/></a></p><ul data-reactid="291"><li data-reactid="292">虽然renderProcess中可以访问到mainProcess里面的全局变量，但是renderProcess里面修改并不会影响到mainPorcess里面的变量</li></ul><p data-reactid="293"><a href="http://ww1.sinaimg.cn/large/bdab2ccely1fjjas3p2gkj2192076dm5.jpg" data-reactid="294"><img src="http://ww1.sinaimg.cn/large/bdab2ccely1fjjas3p2gkj2192076dm5.jpg" alt="alt" width="1622" height="258" data-reactid="295"/></a></p><h2 id="打包方式" data-reactid="296"><a href="#%E6%89%93%E5%8C%85%E6%96%B9%E5%BC%8F" aria-hidden="true" data-reactid="297"><span class="icon icon-link" data-reactid="298"></span></a><!-- react-text: 299 -->打包方式<!-- /react-text --></h2><p data-reactid="300">打包方式，企业云盘用过2种</p><ul data-reactid="301"><li data-reactid="302"><a href="https://github.com/electron-userland/electron-packager" data-reactid="303">electron-package</a></li></ul><pre data-reactid="304"><code data-query="{}" data-lang="data-lang" data-reactid="305">&quot;build&quot;: &quot;electron-packager ./ clouddisk --platform=darwin,win32 --arch=x64 --prune --overwrite --version=1.4.13 --ignore renderProcess/node_modules --icon ./icon&quot;,
&quot;buildwin&quot;: &quot;electron-packager ./ clouddisk --platform=win32 --arch=x64 --prune --overwrite --version=1.4.13 --ignore renderProcess/node_modules --icon ./icon&quot;,
&quot;buildmac&quot;: &quot;electron-packager ./ clouddisk --platform=darwin --arch=x64 --prune --overwrite --version=1.4.3 --ignore renderProcess/node_modules --icon ./icon&quot;,
</code></pre><ul data-reactid="306"><li data-reactid="307"><a href="https://github.com/electron-userland/electron-builder" data-reactid="308">electron-builder</a></li></ul><pre data-reactid="309"><code data-query="{}" data-lang="data-lang" data-reactid="310">&quot;build&quot;: {
    &quot;appId&quot;: &quot;com.electron.ecloud&quot;,
    &quot;productName&quot;: &quot;ecloud&quot;,
    &quot;mac&quot;: {
      &quot;extendInfo&quot;: &quot;build/info.plist&quot;
    },
    // ...
</code></pre><p data-reactid="311">这两种打包方式的区别：</p><p data-reactid="312">electron-package 仅能打出应用程序，无法打出安装包，配置项没有electron-builder那么灵活</p><p data-reactid="313"><!-- react-text: 314 -->electron-builder 支持非常强大的配置，可以参考 <!-- /react-text --><a href="https://github.com/electron-userland/electron-builder/wiki/Options" data-reactid="315">官网</a></p><p data-reactid="316">需要注意的是自动更新需要打出nupkg的包，electron-builder也是支持的</p><pre data-reactid="317"><code data-query="{}" data-lang="data-lang" data-reactid="318">    &quot;win&quot;: {
      &quot;target&quot;: &quot;squirrel&quot;,
      &quot;certificateFile&quot;: &quot;./certs/ecloud.pfx&quot;,
      &quot;certificatePassword&quot;: &quot;***&quot;
    },
    &quot;squirrelWindows&quot;: {
      &quot;iconUrl&quot;: &quot;https://ecloud.baidu.com/static/common/img/auto_logo.ico&quot;
    },
    &quot;nsis&quot;: {
      &quot;oneClick&quot;: false,
      &quot;allowToChangeInstallationDirectory&quot;: true
    },
</code></pre><p data-reactid="319"><a href="http://ww1.sinaimg.cn/large/bdab2ccely1fjjasih7h5j20k9049q51.jpg" data-reactid="320"><img src="http://ww1.sinaimg.cn/large/bdab2ccely1fjjasih7h5j20k9049q51.jpg" alt="alt" width="729" height="153" data-reactid="321"/></a></p><p data-reactid="322">自动更新依赖于squirrel模块，这个模块决定了window的打包方式必须是squirrel的安装包，从而决定了不一样的window安装包（nsis或者squirrel）</p><p data-reactid="323">squirrel安装包依赖于net 4.5</p><h2 id="调试技巧" data-reactid="324"><a href="#%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7" aria-hidden="true" data-reactid="325"><span class="icon icon-link" data-reactid="326"></span></a><!-- react-text: 327 -->调试技巧<!-- /react-text --></h2><ul data-reactid="328"><li data-reactid="329">抓包</li></ul><p data-reactid="330">企业云盘里面所有的请求都基于node的request模块，所以给request设置下代理即可，如下</p><pre data-reactid="331"><code data-query="{}" data-lang="data-lang" data-reactid="332">// 只能代理到http
require(&#x27;./mainProcess/request&#x27;).defaults({ proxy: &#x27;http://127.0.0.1:8888&#x27; }) 
// https如下
let useProxy=1;
if(useProxy){
    process.env.https_proxy = &quot;http://127.0.0.1:8888&quot;;
    process.env.http_proxy = &quot;http://127.0.0.1:8888&quot;;
    process.env.NODE_TLS_REJECT_UNAUTHORIZED = &quot;0&quot;;
}
</code></pre><p data-reactid="333">调试renderProcess 打开browser window的控制台</p><pre data-reactid="334"><code data-query="{}" data-lang="data-lang" data-reactid="335">/localhost/.test(appUrl) &amp;&amp; win.webContents.openDevTools();
</code></pre><ul data-reactid="336"><li data-reactid="337">调试mainProcess</li></ul><p data-reactid="338">console.log直接会在terminal中打出，另外全局有写一个小工具debugInRender,这个工具会将mainProcess的调试信息打印在renderProcess的控制台中</p><ul data-reactid="339"><li data-reactid="340">调试用户的电脑</li></ul><p data-reactid="341">企业云盘-显示包内容-contents-resources-app里面，修改代码重启可生效，</p><p data-reactid="342">当然云盘在打包的时候可以压缩所有代码为asar格式的，只需要在package的配置中添加</p><pre data-reactid="343"><code data-query="{}" data-lang="data-lang" data-reactid="344"> &quot;asar&quot;: true
</code></pre><ul data-reactid="345"><li data-reactid="346">mac中crash情况debugger</li></ul><p data-reactid="347"><a href="https://electron.atom.io/docs/development/debugging-instructions-macos/" data-reactid="348">https://electron.atom.io/docs/development/debugging-instructions-macos/</a></p><ul data-reactid="349"><li data-reactid="350">官方给出的调试方案</li></ul><p data-reactid="351"><a href="https://github.com/electron/electron/blob/master/docs/tutorial/debugging-main-process.md" data-reactid="352">https://github.com/electron/electron/blob/master/docs/tutorial/debugging-main-process.md</a></p><p data-reactid="353">electron 文章</p><p data-reactid="354"><a href="https://nulab-inc.com/blog/typetalk/3-necessary-things-to-correctly-release-a-product-based-on-the-electron-app/" data-reactid="355">https://nulab-inc.com/blog/typetalk/3-necessary-things-to-correctly-release-a-product-based-on-the-electron-app/</a></p><p data-reactid="356">electron和nw区别</p><p data-reactid="357"><a href="https://github.com/electron/electron/blob/master/docs/development/atom-shell-vs-node-webkit.md" data-reactid="358">https://github.com/electron/electron/blob/master/docs/development/atom-shell-vs-node-webkit.md</a></p><h2 id="相关资源" data-reactid="359"><a href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90" aria-hidden="true" data-reactid="360"><span class="icon icon-link" data-reactid="361"></span></a><!-- react-text: 362 -->相关资源<!-- /react-text --></h2><p data-reactid="363"><a href="https://electron.atom.io/docs/" data-reactid="364">https://electron.atom.io/docs/</a></p><p data-reactid="365"><a href="https://github.com/electron-userland/electron-builder" data-reactid="366">https://github.com/electron-userland/electron-builder</a></p><p data-reactid="367"><a href="https://github.com/electron/windows-installer" data-reactid="368">https://github.com/electron/windows-installer</a></p><p data-reactid="369"><a href="https://github.com/ArekSredzki/electron-release-server" data-reactid="370">https://github.com/ArekSredzki/electron-release-server</a></p><p data-reactid="371"><a href="https://github.com/electron/electron/blob/master/docs/development/atom-shell-vs-node-webkit.md" data-reactid="372">https://github.com/electron/electron/blob/master/docs/development/atom-shell-vs-node-webkit.md</a></p><p data-reactid="373"><a href="https://medium.com/developers-writing/building-a-desktop-application-with-electron-204203eeb658" data-reactid="374">https://medium.com/developers-writing/building-a-desktop-application-with-electron-204203eeb658</a></p></article><div data-reactid="375"></div><nav class="single-bar clearfix" data-reactid="376"><span class="prev" data-reactid="377"><a rel="prev" href="/blog/fe/你可能不知道的cookie" data-reactid="378"><em class="eux-icon eux-icon-page-prev" data-reactid="379"></em><!-- react-text: 380 -->你可能不知道的cookie<!-- /react-text --></a></span><span class="next" data-reactid="381"><a rel="next" href="/blog/fe/the-realization-of-svg-smil-animation" data-reactid="382"><em class="eux-icon eux-icon-page-next" data-reactid="383"></em><!-- react-text: 384 -->[译] 使用SMIL实现SVG动画<!-- /react-text --></a></span></nav></div></div></div><footer class="footer" data-reactid="385"><div class="eux-footer-area-wrapper container-singular" role="complementary" data-reactid="386"><div class="inner clearfix" data-reactid="387"><aside id="simple-links-2" class="widget sl-links-main" data-reactid="388"><h2 class="widgettitle" data-reactid="389">友情链接</h2><ul class="simple-links-list simple-links-2-list" id="simple-links-2-list" data-reactid="390"><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="391"><a target="_blank" href="http://sux.baidu.com/" title="百度 FEX 团队" data-reactid="392">百度 FEX</a></li><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="393"><a target="_blank" href="http://efe.baidu.com/" title="百度 EFE 团队" data-reactid="394">百度 EFE</a></li><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="395"><a target="_blank" href="http://sux.baidu.com/" title="百度 SUX 团队" data-reactid="396">百度 SUX</a></li><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="397"><a target="_blank" href="https://aotu.io/" title="京东凹凸实验室，面向多终端技术体系，致力于构建沉淀与分享包括但不限于交互、页面制作技巧、前端开发、原生APP开发等方面的专业知识及案例。" data-reactid="398">凹凸实验室</a></li><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="399"><a target="_blank" href="https://fed.renren.com/" title="人人网FED" data-reactid="400">人人网FED</a></li></ul></aside></div></div><div class="eux-icp" data-reactid="401"><!-- react-text: 402 -->百度EUX 版权所有 ©百度EUX    All rights reserved. 骄傲地采用 <!-- /react-text --><a target="_blank" href="https://github.com/picidaejs/picidaejs" data-reactid="403">Picidae</a><!-- react-text: 404 -->。<!-- /react-text --></div></footer></div>
</div>
<script src="/PICIDAE_COMMON.js"></script>
<script src="/PICIDAE_ENTRY.js"></script>
</body>
</html>