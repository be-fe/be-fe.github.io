<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> npm audit 二三事 | 百度EUX </title>
    <link rel="stylesheet" href="/style.css">
    <script>
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?d232748d06c1fe09a6db3db0077669b7";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();

      var _vds = _vds || [];
      window._vds = _vds;
      (function () {
        _vds.push(['setAccountId', '66707fb8b27442d5b3ccca57a56800fa']);
        _vds.push(['trackBot', false]);

        (function () {
          var vds = document.createElement('script');
          vds.type = 'text/javascript';
          vds.async = true;
          vds.src = '//dn-growing.qbox.me/vds.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(vds, s);
        })();
      })();
    </script>
</head>
<body>
<div id="root">
    <div class="main" data-reactroot="" data-reactid="1" data-react-checksum="207029996"><!-- react-empty: 2 --><header class="eux-header clearfix" data-reactid="3"><div class="eux-header-top" data-reactid="4"><a href="javascript:void(0);" class="eux-portable-menu" data-reactid="5"><span data-reactid="6"></span><span data-reactid="7"></span><span data-reactid="8"></span></a><!-- react-empty: 9 --><nav class="menu-primary-container" data-reactid="10"><ul id="menu-primary" class="menu" data-reactid="11"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-25" data-reactid="12"><a href="/" data-reactid="13">HOME</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom current-menu-ancestor current-menu-parent menu-item-has-children menu-item-45" data-reactid="14"><a href="/" data-reactid="15">BLOG</a><ul class="sub-menu" data-reactid="16"><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-menu-item menu-item-63" data-reactid="17"><a href="/ue" data-reactid="18">交互</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-menu-item menu-item-63" data-reactid="19"><a href="/ui" data-reactid="20">视觉</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-menu-item menu-item-63" data-reactid="21"><a href="/fe" data-reactid="22">前端</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-menu-item menu-item-63" data-reactid="23"><a href="/team" data-reactid="24">团队</a></li></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-46" data-reactid="25"><a href="/tools" data-reactid="26">TOOLS</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-112" data-reactid="27"><a href="/works" data-reactid="28">WORKS</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-138" data-reactid="29"><a href="/jobs" data-reactid="30">JOBS</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-50" data-reactid="31"><a href="/about-us" data-reactid="32">ABOUT US</a></li></ul></nav></div></header><div class="eux-singular clearfix" data-reactid="33"><div class="container-singular clearfix" data-reactid="34"><nav class="menu-categories-container" data-reactid="35"><ul id="menu-categories" class="menu" data-reactid="36"><li class="menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="37"><span data-reactid="38"><a href="/" data-reactid="39">全部</a></span></li><li class="menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="40"><span data-reactid="41"><a href="/ue" data-reactid="42">交互</a></span></li><li class="menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="43"><span data-reactid="44"><a href="/ui" data-reactid="45">视觉</a></span></li><li class="current-menu-item menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="46"><span data-reactid="47"><a href="/fe" data-reactid="48">前端</a></span></li><li class="menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="49"><span data-reactid="50"><a href="/team" data-reactid="51">团队</a></span></li></ul></nav><div class="inner clearfix" data-reactid="52"><div class="article-meta" data-reactid="53"><h1 class="title" data-reactid="54">npm audit 二三事</h1><div class="eux-page-detail" data-reactid="55"><span data-reactid="56"><em data-reactid="57">by.</em><!-- react-text: 58 -->陈蔓青<!-- /react-text --></span><span data-reactid="59">2018-7-2</span></div></div><article data-reactid="60"><h2 id="前言：从一个-bug-说起" data-reactid="61"><a href="#%E5%89%8D%E8%A8%80%EF%BC%9A%E4%BB%8E%E4%B8%80%E4%B8%AA-bug-%E8%AF%B4%E8%B5%B7" aria-hidden="true" data-reactid="62"><span class="icon icon-link" data-reactid="63"></span></a><!-- react-text: 64 -->前言：从一个 bug 说起<!-- /react-text --></h2><p data-reactid="65"><!-- react-text: 66 -->最近碰到一个问题，使用一个框架的时候使用公司内部的镜像装怎么都跑不起来, 然而只要改成官方的镜像就没问题，于是去对比了下 <!-- /react-text --><code data-reactid="67">package.lock</code><!-- react-text: 68 --> 文件，如图：<!-- /react-text --></p><img src="https://eux-public.bj.bcebos.com/2018/07/02/df233513dd3e36bafdd4a15a69415bdc.jpg" alt="alt" width="1202" height="761" data-reactid="69"/><p data-reactid="70"><!-- react-text: 71 -->很明显可以看出用我厂的镜像装出来的 <!-- /react-text --><code data-reactid="72">nanomatch</code><!-- react-text: 73 --> 是 <!-- /react-text --><code data-reactid="74">1.2.11</code><!-- react-text: 75 --> 的版本，而官方装的 <!-- /react-text --><code data-reactid="76">1.2.9</code><!-- react-text: 77 -->，心里一愣我去还能超前，老早听说 <!-- /react-text --><code data-reactid="78">npm@6</code><!-- react-text: 79 --> 的一主要特征是安全机制，脑洞了一下难道官方 <!-- /react-text --><code data-reactid="80">npm</code><!-- react-text: 81 --> 源能判断是不是有问题的包还能自动回滚到稳定版本？<!-- /react-text --></p><p data-reactid="82">研究了一番，正文开始：</p><h2 id="npm-audit-命令" data-reactid="83"><a href="#npm-audit-%E5%91%BD%E4%BB%A4" aria-hidden="true" data-reactid="84"><span class="icon icon-link" data-reactid="85"></span></a><!-- react-text: 86 -->npm audit 命令<!-- /react-text --></h2><p data-reactid="87"><!-- react-text: 88 -->首先看<!-- /react-text --><a href="https://medium.com/npm-inc/announcing-npm-6-5d0b1799a905" data-reactid="89">官方文档</a><!-- react-text: 90 -->，<!-- /react-text --><code data-reactid="91">npm@6</code><!-- react-text: 92 --> 的一大更新是新增了 <!-- /react-text --><code data-reactid="93">npm audit</code><!-- react-text: 94 --> 命令<!-- /react-text --></p><blockquote data-reactid="95"><p data-reactid="96"><strong data-reactid="97">Note: The npm audit command is available in npm@6. To upgrade, run npm install npm@latest -g.</strong></p><p data-reactid="98"><!-- react-text: 99 -->The <!-- /react-text --><code data-reactid="100">npm audit</code><!-- react-text: 101 --> command submits a description of the dependencies configured in your package to your default registry and asks for a report of known vulnerabilities. npm audit checks direct dependencies, devDependencies, bundledDependencies, and optionalDependencies, but does not check peerDependencies.<!-- /react-text --></p></blockquote><p data-reactid="102">该命令会在项目中更新或者下载新的依赖包之后会自动运行，如果你在项目中使用了具有已知安全问题的依赖，就收到官方的警告通知。</p><p data-reactid="103"><!-- react-text: 104 -->为了复现，随便找了一个没那么官方的项目 <!-- /react-text --><a href="https://github.com/mrvautin/adminMongo" data-reactid="105">adminMongo</a><!-- react-text: 106 --> 并执行 <!-- /react-text --><code data-reactid="107">npm install</code><!-- react-text: 108 --> 试试，果然<!-- /react-text --></p><pre data-reactid="109"><code data-query="{}" data-lang="data-lang" data-reactid="110">found 5 vulnerabilities (2 low, 1 moderate, 1 high, 1 critical)
  run `npm audit fix` to fix them, or `npm audit` for details
</code></pre><p data-reactid="111"><!-- react-text: 112 -->再执行下 <!-- /react-text --><code data-reactid="113">npm audit</code><!-- react-text: 114 --> 查看详情，列表很清晰。<!-- /react-text --></p><img src="https://eux-public.bj.bcebos.com/2018/07/03/9D8FAEFD-85A5-45C2-8DCF-7B312AB9204D.png" alt="alt" width="1232" height="944" data-reactid="115"/><p data-reactid="116"><!-- react-text: 117 -->执行 <!-- /react-text --><code data-reactid="118">npm audit fix</code><!-- react-text: 119 -->，发现并没有能自动的帮我 fix 掉这些错误。<!-- /react-text --></p><pre data-reactid="120"><code class="hljs language-bash" data-query="{}" data-lang="bash" data-reactid="121"><!-- react-text: 122 -->fixed 0 of 5 vulnerabilities <!-- /react-text --><span class="hljs-keyword" data-reactid="123">in</span><!-- react-text: 124 --> 1295 scanned packages
  2 package updates <!-- /react-text --><span class="hljs-keyword" data-reactid="125">for</span><!-- react-text: 126 --> 5 vulns involved breaking changes
  (use `npm audit fix --force` to install breaking changes; or <!-- /react-text --><span class="hljs-keyword" data-reactid="127">do</span><!-- react-text: 128 --> it by hand)<!-- /react-text --></code></pre><p data-reactid="129"><!-- react-text: 130 -->根据提示尝试执行 <!-- /react-text --><code data-reactid="131">npm audit fix --force</code><!-- react-text: 132 -->，发现他帮我把包自动更新到了推荐版本（<!-- /react-text --><code data-reactid="133">supertest@3.1.0</code><!-- react-text: 134 -->，<!-- /react-text --><code data-reactid="135">mocha@5.2.0</code><!-- react-text: 136 -->）。<!-- /react-text --></p><p data-reactid="137"><!-- react-text: 138 -->ps. 直接运行 <!-- /react-text --><code data-reactid="139">--force</code><!-- react-text: 140 --> 的行为不要学习，对于没能自动修复的问题，说明肯定出现了 <!-- /react-text --><code data-reactid="141">SEMVER WARNING</code><!-- react-text: 142 --> 之类的警告，这意味着推荐的修复版本存在让代码出问题的可能，主要发生在依赖包更改了 API 或者升级了大版本的情况下（semantic version major change，比如我这个项目的 <!-- /react-text --><code data-reactid="143">supertest</code><!-- react-text: 144 --> 版本是 1.2.0，而推荐的是 3.1.0）。这时候就需要格外的小心甚至需要改动一些自己的代码了。<!-- /react-text --></p><p data-reactid="145">另外还有一种情况，就是官方发现了漏洞，但是目前没有可用的补丁。这时候就是个体力劳动了 :)</p><p data-reactid="146"><!-- react-text: 147 -->看看这命令到底帮我们干了啥，简单翻译了一下 <!-- /react-text --><a href="https://docs.npmjs.com/cli/audit" data-reactid="148">官方文档</a></p><pre data-reactid="149"><code class="hljs language-bash" data-query="{}" data-lang="bash" data-reactid="150"><span class="hljs-comment" data-reactid="151"># 扫描项目漏洞把不安全的依赖项自动更新到兼容性版本</span><!-- react-text: 152 -->
npm audit fix

<!-- /react-text --><span class="hljs-comment" data-reactid="153"># 在不修改 node_modules 的情况下执行 audit fix，仍然会更改 pkglock</span><!-- react-text: 154 -->
npm audit fix --package-lock-only

<!-- /react-text --><span class="hljs-comment" data-reactid="155"># 跳过更新 devDependencies</span><!-- react-text: 156 -->
npm audit fix --only=prod

<!-- /react-text --><span class="hljs-comment" data-reactid="157"># 强制执行 audit fix 安装最新的依赖项（toplevel）</span><!-- react-text: 158 -->
npm audit fix --force

<!-- /react-text --><span class="hljs-comment" data-reactid="159"># 单纯的获取 audit fix 会做的事，并以 json 格式输出。</span><!-- react-text: 160 -->
npm audit fix --dry-run --json

<!-- /react-text --><span class="hljs-comment" data-reactid="161"># 获取详情</span><!-- react-text: 162 -->
npm audit

<!-- /react-text --><span class="hljs-comment" data-reactid="163"># 以 JSON 格式打印报告</span><!-- react-text: 164 -->
npm audit --json<!-- /react-text --></code></pre><p data-reactid="165">至于如何关闭安全检查，可以采用以下方式：</p><ul data-reactid="166"><li data-reactid="167"><!-- react-text: 168 -->安装单个包关闭安全审查: <!-- /react-text --><code data-reactid="169">npm install example-package-name --no-audit</code></li><li data-reactid="170"><!-- react-text: 171 -->安装所有包关闭安全审查 - 运行 <!-- /react-text --><code data-reactid="172">npm set audit false</code><!-- react-text: 173 --> - 手动将 <!-- /react-text --><code data-reactid="174">~/.npmrc</code><!-- react-text: 175 --> 配置文件中的 <!-- /react-text --><code data-reactid="176">audit</code><!-- react-text: 177 --> 修改为 <!-- /react-text --><code data-reactid="178">false</code></li></ul><h2 id="audit-报告" data-reactid="179"><a href="#audit-%E6%8A%A5%E5%91%8A" aria-hidden="true" data-reactid="180"><span class="icon icon-link" data-reactid="181"></span></a><!-- react-text: 182 -->audit 报告<!-- /react-text --></h2><p data-reactid="183"><!-- react-text: 184 -->通过查看文档和源码发现，<!-- /react-text --><code data-reactid="185">npm aduit</code><!-- react-text: 186 --> 主要动作就是在 <!-- /react-text --><code data-reactid="187">npm install</code><!-- react-text: 188 --> 完成之后把需要检查的包的信息发送给一个官方接口, 再根据返回信息生成一个包含包名称、漏洞严重性、简介, 路径等的报告。处理格式化什么的主要在于 <!-- /react-text --><a href="https://www.npmjs.com/package/npm-audit-report" data-reactid="189">npm-audit-report</a><!-- react-text: 190 --> 模块，有兴趣的也可以研究下。<!-- /react-text --></p><p data-reactid="191"><!-- react-text: 192 -->那么报告是根据什么生成的呢，根据 audit 的提示信息我们能发现一个 <!-- /react-text --><a href="https://nodesecurity.io/" data-reactid="193">node 安全平台</a><!-- react-text: 194 -->，进去首页就看到一句类似『好消息，2018 年 4 月 10 号，npm 正式入驻我们平台』的通知。看来 audit 的数据来源也大概知道了。<!-- /react-text --></p><p data-reactid="195">该平台的公布一个漏洞的步骤跟大多安全平台类似：</p><ol data-reactid="196"><li data-reactid="197">漏洞被披露 or 反馈到此安全平台。</li><li data-reactid="198">通知维护者相关信息（如果不是维护者自己汇报的）。</li><li data-reactid="199">通知使用该依赖的用户，给给予推荐性的解决方案。</li><li data-reactid="200"><!-- react-text: 201 -->修复完成之后发布公开补丁，并申请 <!-- /react-text --><a href="http://cve.mitre.org/" data-reactid="202">CVE</a><!-- react-text: 203 --> 。<!-- /react-text --></li><li data-reactid="204">如果 45 天之后还没有修复，则通知超时并公开漏洞。</li></ol><h2 id="总结" data-reactid="205"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" data-reactid="206"><span class="icon icon-link" data-reactid="207"></span></a><!-- react-text: 208 -->总结<!-- /react-text --></h2><p data-reactid="209"><!-- react-text: 210 -->总的来说，安全的问题不容忽视。 很多时候，大家拿到项目之后直接 <!-- /react-text --><code data-reactid="211">npm install</code><!-- react-text: 212 -->，只要项目能成功运行基本没有人会去关注装了什么。一大堆错综复杂的相互关联的依赖包，就算开发者有安全意识，也缺乏解决安全漏洞的手段。 此时有个官方平台来帮忙管理收集反馈给出报告给出建议等，是一件很值得称赞的事。<!-- /react-text --></p><h2 id="最后的最后" data-reactid="213"><a href="#%E6%9C%80%E5%90%8E%E7%9A%84%E6%9C%80%E5%90%8E" aria-hidden="true" data-reactid="214"><span class="icon icon-link" data-reactid="215"></span></a><!-- react-text: 216 -->最后的最后<!-- /react-text --></h2><p data-reactid="217"><!-- react-text: 218 -->想到目前已经有很大一部分同学转移去了 <!-- /react-text --><code data-reactid="219">yarn</code><!-- react-text: 220 --> 阵营，甚至有一些并不知道为什么就转过去了只是当时很多人推荐使用它。其实主要是在 npm v4 时期安裝超慢，才会让 yarn 崛起，在 v5 的时候其实改善不少了，v6 应该是再次强调想夺回这么一部分用户 😐？有兴趣的可以再自行研究下 yarn 和 npm 的对比， 这里有一个 <!-- /react-text --><a href="/https//github.com/appleboy/npm-vs-yarn" data-reactid="221">npm5.7.1 vs yarn1.5.1 数据上的比较以及比较方法</a><!-- react-text: 222 -->。<!-- /react-text --></p><p data-reactid="223"><!-- react-text: 224 -->再有其实 npm 现在也有很多功能似乎用的人不是很多，篇幅有限简单提几个自认为还不错的。 1. <!-- /react-text --><code data-reactid="225">npx</code><!-- react-text: 226 --> 一个随着 <!-- /react-text --><code data-reactid="227">npm 5.2.0</code><!-- react-text: 228 --> 发布的命令，会帮你执行依赖包里的二进制文件。比如对于没有全局安装的命令你想执行的话就只能 <!-- /react-text --><code data-reactid="229">./node_modules/.bin/webpack -v</code><!-- react-text: 230 -->，有 <!-- /react-text --><code data-reactid="231">npx</code><!-- react-text: 232 --> 之后就可以直接使用 <!-- /react-text --><code data-reactid="233">npx webpack -v</code><!-- react-text: 234 -->。另外还能单次命令而不需要全局安装，比如 <!-- /react-text --><code data-reactid="235">npx create-react-app my-app</code><!-- react-text: 236 --> 2. 更改 npm 安装包的目录<!-- /react-text --><code data-reactid="237">npm config set prefix &lt;new_path&gt;</code><!-- react-text: 238 -->（在没有 sudo 权限的场景很有用） 3. 在开发 npm 模块的时候使用 <!-- /react-text --><code data-reactid="239">npm link</code><!-- react-text: 240 --> 4. ...<!-- /react-text --></p><p data-reactid="241"><!-- react-text: 242 -->至于前面说的问题解决方案，咨询了官方同学以及翻了下 nanomatch 的 <!-- /react-text --><a href="https://github.com/micromatch/nanomatch/issues/15" data-reactid="243">issue</a><!-- react-text: 244 -->，发现是包的问题。 (npm 发布了错误版本 1.11 然后及时回滚到了 1.9 并且删除了 11 的版本, 但是我厂镜像没及时同步版本还是 1.11, 而自己刚好卡这间隙)，果然当晚回到家之后再看了一眼一切又恢复正常，就当一个学习知识的经历。<!-- /react-text --></p><h2 id="参考资料" data-reactid="245"><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" aria-hidden="true" data-reactid="246"><span class="icon icon-link" data-reactid="247"></span></a><!-- react-text: 248 -->参考资料<!-- /react-text --></h2><ul data-reactid="249"><li data-reactid="250"><a href="https://docs.npmjs.com/cli/audit" data-reactid="251">npm audit 文档</a></li><li data-reactid="252"><a href="https://zhuanlan.zhihu.com/p/27891196" data-reactid="253">【科普】不了解CVE 就不能算是安全圈的人 来看看官方权威解答</a></li></ul></article><div data-reactid="254"></div><nav class="single-bar clearfix" data-reactid="255"><span class="prev" data-reactid="256"><a rel="prev" href="/blog/fe/微信小程序架构原理" data-reactid="257"><em class="eux-icon eux-icon-page-prev" data-reactid="258"></em><!-- react-text: 259 -->微信小程序架构原理<!-- /react-text --></a></span><span class="next" data-reactid="260"><a rel="next" href="/blog/fe/how-to-write-component-demo" data-reactid="261"><em class="eux-icon eux-icon-page-next" data-reactid="262"></em><!-- react-text: 263 -->书写组件 DEMO 的一些方案<!-- /react-text --></a></span></nav></div></div></div><footer class="footer" data-reactid="264"><div class="eux-footer-area-wrapper container-singular" role="complementary" data-reactid="265"><div class="inner clearfix" data-reactid="266"><aside id="simple-links-2" class="widget sl-links-main" data-reactid="267"><h2 class="widgettitle" data-reactid="268">友情链接</h2><ul class="simple-links-list simple-links-2-list" id="simple-links-2-list" data-reactid="269"><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="270"><a target="_blank" href="http://sux.baidu.com/" title="百度 FEX 团队" data-reactid="271">百度 FEX</a></li><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="272"><a target="_blank" href="http://efe.baidu.com/" title="百度 EFE 团队" data-reactid="273">百度 EFE</a></li><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="274"><a target="_blank" href="http://sux.baidu.com/" title="百度 SUX 团队" data-reactid="275">百度 SUX</a></li><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="276"><a target="_blank" href="https://aotu.io/" title="京东凹凸实验室，面向多终端技术体系，致力于构建沉淀与分享包括但不限于交互、页面制作技巧、前端开发、原生APP开发等方面的专业知识及案例。" data-reactid="277">凹凸实验室</a></li><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="278"><a target="_blank" href="https://fed.renren.com/" title="人人网FED" data-reactid="279">人人网FED</a></li></ul></aside></div></div><div class="eux-icp" data-reactid="280"><!-- react-text: 281 -->百度EUX 版权所有 ©百度EUX    All rights reserved. 骄傲地采用 <!-- /react-text --><a target="_blank" href="https://github.com/picidaejs/picidaejs" data-reactid="282">Picidae</a><!-- react-text: 283 -->。<!-- /react-text --></div></footer></div>
</div>
<script src="/PICIDAE_COMMON.js"></script>
<script src="/PICIDAE_ENTRY.js"></script>
</body>
</html>