<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Riot.js 框架深入解析 | 百度EUX </title>
    <link rel="stylesheet" href="/style.css">
    <script>
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?d232748d06c1fe09a6db3db0077669b7";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();

      var _vds = _vds || [];
      window._vds = _vds;
      (function () {
        _vds.push(['setAccountId', '66707fb8b27442d5b3ccca57a56800fa']);
        _vds.push(['trackBot', false]);

        (function () {
          var vds = document.createElement('script');
          vds.type = 'text/javascript';
          vds.async = true;
          vds.src = '//dn-growing.qbox.me/vds.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(vds, s);
        })();
      })();
    </script>
</head>
<body>
<div id="root">
    <div class="main" data-reactroot="" data-reactid="1" data-react-checksum="-1810567660"><!-- react-empty: 2 --><header class="eux-header clearfix" data-reactid="3"><div class="eux-header-top" data-reactid="4"><a href="javascript:void(0);" class="eux-portable-menu" data-reactid="5"><span data-reactid="6"></span><span data-reactid="7"></span><span data-reactid="8"></span></a><!-- react-empty: 9 --><nav class="menu-primary-container" data-reactid="10"><ul id="menu-primary" class="menu" data-reactid="11"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-25" data-reactid="12"><a href="/" data-reactid="13">HOME</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom current-menu-ancestor current-menu-parent menu-item-has-children menu-item-45" data-reactid="14"><a href="/" data-reactid="15">BLOG</a><ul class="sub-menu" data-reactid="16"><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-menu-item menu-item-63" data-reactid="17"><a href="/ue" data-reactid="18">交互</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-menu-item menu-item-63" data-reactid="19"><a href="/ui" data-reactid="20">视觉</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-menu-item menu-item-63" data-reactid="21"><a href="/fe" data-reactid="22">前端</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-menu-item menu-item-63" data-reactid="23"><a href="/team" data-reactid="24">团队</a></li></ul></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-46" data-reactid="25"><a href="/tools" data-reactid="26">TOOLS</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-112" data-reactid="27"><a href="/works" data-reactid="28">WORKS</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-138" data-reactid="29"><a href="/jobs" data-reactid="30">JOBS</a></li><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-50" data-reactid="31"><a href="/about-us" data-reactid="32">ABOUT US</a></li></ul></nav></div></header><div class="eux-singular clearfix" data-reactid="33"><div class="container-singular clearfix" data-reactid="34"><nav class="menu-categories-container" data-reactid="35"><ul id="menu-categories" class="menu" data-reactid="36"><li class="menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="37"><span data-reactid="38"><a href="/" data-reactid="39">全部</a></span></li><li class="menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="40"><span data-reactid="41"><a href="/ue" data-reactid="42">交互</a></span></li><li class="menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="43"><span data-reactid="44"><a href="/ui" data-reactid="45">视觉</a></span></li><li class="current-menu-item menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="46"><span data-reactid="47"><a href="/fe" data-reactid="48">前端</a></span></li><li class="menu-item menu-item-type-custom menu-item-object-custom current_page_item menu-item-55" data-reactid="49"><span data-reactid="50"><a href="/team" data-reactid="51">团队</a></span></li></ul></nav><div class="inner clearfix" data-reactid="52"><div class="article-meta" data-reactid="53"><h1 class="title" data-reactid="54">Riot.js 框架深入解析</h1><div class="eux-page-detail" data-reactid="55"><span data-reactid="56"><em data-reactid="57">by.</em><!-- react-text: 58 -->田光宇<!-- /react-text --></span><span data-reactid="59">2017-12-25</span></div></div><article data-reactid="60"><p data-reactid="61">最近整理了下团队新人文档，对团队内使用的框架 riot.js 这部分内容做了一些总结。本文主要在 riot.js 源码 方面，分析一下 riot.js 的执行原理和使用优化。</p><h2 id="riotjs-简介" data-reactid="62"><a href="#riotjs-%E7%AE%80%E4%BB%8B" aria-hidden="true" data-reactid="63"><span class="icon icon-link" data-reactid="64"></span></a><!-- react-text: 65 -->Riot.js 简介<!-- /react-text --></h2><blockquote data-reactid="66"><p data-reactid="67">Simple and elegant component-based UI library (Riot.js)</p></blockquote><p data-reactid="68">riot.js 是一个简单优雅的 js UI框架。具有自定义标签，简单语法，API简单，体积小， 学习成本低等特点。riot.js 使用Model-View-Presenter (MVP)设计模式来组织代码， 这样它能够更模块化、更具可测试性且易于理解。riot.js 仅仅提供了帮助UI渲染相关的基础功能 ，并不具备其它复杂的功能，因此其体积很小，压缩后仅有 10.39KB (react.min.js 大约 47.6KB )， 很适合组件类的业务开发。</p><h3 id="hello-world" data-reactid="69"><a href="#hello-world" aria-hidden="true" data-reactid="70"><span class="icon icon-link" data-reactid="71"></span></a><!-- react-text: 72 -->Hello world<!-- /react-text --></h3><p data-reactid="73"><!-- react-text: 74 -->尝试 Riot.js 最简单的方法是使用 <!-- /react-text --><a href="https://jsfiddle.net/CaelumTian/c9j9jvkz/" data-reactid="75">JSFiddle Hello Riot.js</a><!-- react-text: 76 --> 例子。你可以在浏览器中打开它。 或者你也可以创建一个 .html 文件，然后通过如下方式引入Riot.js:<!-- /react-text --></p><pre data-reactid="77"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="78"><!-- react-text: 79 -->&lt;script src=<!-- /react-text --><span class="hljs-string" data-reactid="80">&quot;https://cdn.jsdelivr.net/npm/riot@3.7/riot+compiler.min.js&quot;</span><!-- react-text: 81 -->&gt;<!-- /react-text --><span class="xml" data-reactid="82"><span class="hljs-tag" data-reactid="83"><!-- react-text: 84 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="85">scipt</span><!-- react-text: 86 -->&gt;<!-- /react-text --></span></span><!-- react-text: 87 --> <!-- /react-text --></code></pre><h3 id="自定义标签" data-reactid="88"><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%87%E7%AD%BE" aria-hidden="true" data-reactid="89"><span class="icon icon-link" data-reactid="90"></span></a><!-- react-text: 91 -->自定义标签<!-- /react-text --></h3><p data-reactid="92">Riot.js 采用自定义标签的语法，每个自定义标签都可以看做是一个组件(Riot.js Tag 对象)，自定义标签将相关的 HTML 和 JavaScript 粘合在一起，成为一个可重用的组件。可以认为它同时具有 React 和 Polymer 的优点，但是语法更友好，学习成本更小。</p><pre data-reactid="93"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="94"><!-- react-text: 95 -->&lt;riot-demo&gt;  
    <!-- /react-text --><span class="xml" data-reactid="96"><span class="hljs-tag" data-reactid="97"><!-- react-text: 98 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="99">span</span><!-- react-text: 100 -->&gt;<!-- /react-text --></span><!-- react-text: 101 -->{ title }<!-- /react-text --><span class="hljs-tag" data-reactid="102"><!-- react-text: 103 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="104">span</span><!-- react-text: 105 -->&gt;<!-- /react-text --></span></span><!-- react-text: 106 -->   
    &lt;script&gt;
        <!-- /react-text --><span class="hljs-keyword" data-reactid="107">this</span><!-- react-text: 108 -->.title = <!-- /react-text --><span class="hljs-string" data-reactid="109">&quot;Hello World&quot;</span><!-- react-text: 110 -->;
    <!-- /react-text --><span class="xml" data-reactid="111"><span class="hljs-tag" data-reactid="112"><!-- react-text: 113 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="114">script</span><!-- react-text: 115 -->&gt;<!-- /react-text --></span></span><!-- react-text: 116 -->
&lt;<!-- /react-text --><span class="hljs-regexp" data-reactid="117">/riot-demo&gt; </span></code></pre><p data-reactid="118"><!-- react-text: 119 -->在团队中，我们会使用 webpack 来构建 riot 项目。每个组件都被写成一个 <!-- /react-text --><code data-reactid="120">*.tag</code><!-- react-text: 121 --> 文件。<!-- /react-text --></p><h2 id="riotjs-基本执行原理" data-reactid="122"><a href="#riotjs-%E5%9F%BA%E6%9C%AC%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86" aria-hidden="true" data-reactid="123"><span class="icon icon-link" data-reactid="124"></span></a><!-- react-text: 125 -->Riot.js 基本执行原理<!-- /react-text --></h2><p data-reactid="126"><!-- react-text: 127 -->一个riot自定义标签在日常开发中从源码到呈现在页面上主要分为三步：编译（一般利用官方自带编译工具）、注册（riot.tag()）和加载（riot.mount()），如下图所示：<!-- /react-text --><br data-reactid="128"/><img src="https://caelumtian.github.io/2017/09/21/riot-js-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%901/a.png" alt="alt" width="387" height="365" data-reactid="129"/></p><h3 id="编译" data-reactid="130"><a href="#%E7%BC%96%E8%AF%91" aria-hidden="true" data-reactid="131"><span class="icon icon-link" data-reactid="132"></span></a><!-- react-text: 133 -->编译<!-- /react-text --></h3><p data-reactid="134">编译阶段的主要工作就是将riot语法写的.tag文件转换为可执行的.js文件，这部分主要靠编译器来完成。例如：</p><pre data-reactid="135"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="136"><!-- react-text: 137 -->riot.tag2(<!-- /react-text --><span class="hljs-string" data-reactid="138">&#x27;content-demo&#x27;</span><!-- react-text: 139 -->, <!-- /react-text --><span class="hljs-string" data-reactid="140">&#x27;&lt;h1&gt;{message}&lt;/h1&gt;&#x27;</span><!-- react-text: 141 -->, <!-- /react-text --><span class="hljs-string" data-reactid="142">&#x27;&#x27;</span><!-- react-text: 143 -->, <!-- /react-text --><span class="hljs-function" data-reactid="144"><span class="hljs-keyword" data-reactid="145">function</span><!-- react-text: 146 --> (<!-- /react-text --><span class="hljs-params" data-reactid="147">opts</span><!-- react-text: 148 -->) <!-- /react-text --></span><!-- react-text: 149 -->{
	<!-- /react-text --><span class="hljs-keyword" data-reactid="150">this</span><!-- react-text: 151 -->.message = <!-- /react-text --><span class="hljs-string" data-reactid="152">&#x27;hello world&#x27;</span><!-- react-text: 153 -->;
}); <!-- /react-text --></code></pre><p data-reactid="154">riot.tag2 函数在 riot.js 源码中的 core.js 文件中，代码如下：</p><pre data-reactid="155"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="156"><span class="hljs-keyword" data-reactid="157">export</span><!-- react-text: 158 --> <!-- /react-text --><span class="hljs-function" data-reactid="159"><span class="hljs-keyword" data-reactid="160">function</span><!-- react-text: 161 --> <!-- /react-text --><span class="hljs-title" data-reactid="162">tag2</span><!-- react-text: 163 -->(<!-- /react-text --><span class="hljs-params" data-reactid="164">name, tmpl, css, attrs, fn</span><!-- react-text: 165 -->) <!-- /react-text --></span><!-- react-text: 166 -->{
    <!-- /react-text --><span class="hljs-keyword" data-reactid="167">if</span><!-- react-text: 168 --> (css) styleManager.add(css, name)
    <!-- /react-text --><span class="hljs-comment" data-reactid="169">// tags implementation cache 标签接口缓存</span><!-- react-text: 170 -->
    __TAG_IMPL[name] = {
        name,
        tmpl,
        attrs,
        fn
    }
    <!-- /react-text --><span class="hljs-keyword" data-reactid="171">return</span><!-- react-text: 172 --> name
}<!-- /react-text --></code></pre><p data-reactid="173">参数含义如下：</p><ul data-reactid="174"><li data-reactid="175">name: riot 自定义标签的名称</li><li data-reactid="176">tmpl: 标签的html内容</li><li data-reactid="177"><!-- react-text: 178 -->css: <!-- /react-text --><code data-reactid="179"></code><!-- react-text: 180 --> 标签中的内容<!-- /react-text --></li><li data-reactid="181">attrs: riot 自定义标签的属性</li><li data-reactid="182"><!-- react-text: 183 -->fn: 用户自定义函数,即 <!-- /react-text --><code data-reactid="184"></code><!-- react-text: 185 --> 标签中的内容<!-- /react-text --></li></ul><p data-reactid="186"><code data-reactid="187">riot.tag2()</code><!-- react-text: 188 --> 函数将 riot tag 注册到了 <!-- /react-text --><code data-reactid="189">__TAG_IMP</code><!-- react-text: 190 --> 对象中，方便之后的使用，css部分则被添加到了 <!-- /react-text --><code data-reactid="191">byName</code><!-- react-text: 192 --> 变量中，用于之后统一添加到页面中。在源代码中，还有一个 <!-- /react-text --><code data-reactid="193">riot.tag()</code><!-- react-text: 194 -->函数，这个函数用于直接直接创建一个 riot tag 实例的接口，而 <!-- /react-text --><code data-reactid="195">riot.tag2()</code><!-- react-text: 196 --> 是暴露给编辑器的接口，本质上功能是一样的。<!-- /react-text --></p><h3 id="加载-riotmount" data-reactid="197"><a href="#%E5%8A%A0%E8%BD%BD-riotmount" aria-hidden="true" data-reactid="198"><span class="icon icon-link" data-reactid="199"></span></a><!-- react-text: 200 -->加载 riot.mount()<!-- /react-text --></h3><p data-reactid="201"><!-- react-text: 202 -->组件被注册好以后，并没有被渲染，直到我们调用 <!-- /react-text --><code data-reactid="203">riot.mount()</code><!-- react-text: 204 --> 函数后，相应的组件才会渲染到页面上。源码如下：<!-- /react-text --></p><pre data-reactid="205"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="206"><span class="hljs-keyword" data-reactid="207">export</span><!-- react-text: 208 --> <!-- /react-text --><span class="hljs-function" data-reactid="209"><span class="hljs-keyword" data-reactid="210">function</span><!-- react-text: 211 --> <!-- /react-text --><span class="hljs-title" data-reactid="212">mount</span><!-- react-text: 213 -->(<!-- /react-text --><span class="hljs-params" data-reactid="214">selector, tagName, opts</span><!-- react-text: 215 -->) <!-- /react-text --></span><!-- react-text: 216 -->{
    <!-- /react-text --><span class="hljs-keyword" data-reactid="217">const</span><!-- react-text: 218 --> tags = []
    <!-- /react-text --><span class="hljs-keyword" data-reactid="219">let</span><!-- react-text: 220 --> elem, allTags
    <!-- /react-text --><span class="hljs-comment" data-reactid="221">// root {HTMLElement} riot-tag 标签节点</span><!-- react-text: 222 -->
    <!-- /react-text --><span class="hljs-function" data-reactid="223"><span class="hljs-keyword" data-reactid="224">function</span><!-- react-text: 225 --> <!-- /react-text --><span class="hljs-title" data-reactid="226">pushTagsTo</span><!-- react-text: 227 -->(<!-- /react-text --><span class="hljs-params" data-reactid="228">root</span><!-- react-text: 229 -->) <!-- /react-text --></span><!-- react-text: 230 -->{
        <!-- /react-text --><span class="hljs-keyword" data-reactid="231">if</span><!-- react-text: 232 --> (root.tagName) {
            <!-- /react-text --><span class="hljs-keyword" data-reactid="233">let</span><!-- react-text: 234 --> riotTag = getAttr(root, IS_DIRECTIVE),    <!-- /react-text --><span class="hljs-comment" data-reactid="235">// 要么 data-is 要么 root.tagName 本身</span><!-- react-text: 236 -->
                tag
            <!-- /react-text --><span class="hljs-comment" data-reactid="237">// ① 设置 data-is 属性指向</span><!-- react-text: 238 -->
            <!-- /react-text --><span class="hljs-keyword" data-reactid="239">if</span><!-- react-text: 240 --> (tagName &amp;&amp; riotTag !== tagName) {
                riotTag = tagName
                setAttr(root, IS_DIRECTIVE, tagName)
            }
            <!-- /react-text --><span class="hljs-comment" data-reactid="241">// ② mountTo 创建一个新的 riot tag 实例</span><!-- react-text: 242 -->
            tag = mountTo(root, riotTag || root.tagName.toLowerCase(), opts)
            <!-- /react-text --><span class="hljs-keyword" data-reactid="243">if</span><!-- react-text: 244 --> (tag)
                tags.push(tag)
        } <!-- /react-text --><span class="hljs-keyword" data-reactid="245">else</span><!-- react-text: 246 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="247">if</span><!-- react-text: 248 --> (root.length)
            each(root, pushTagsTo)
    }
    <!-- /react-text --><span class="hljs-comment" data-reactid="249">// DOM 注入 style 标签</span><!-- react-text: 250 -->
    styleManager.inject()
    <!-- /react-text --><span class="hljs-keyword" data-reactid="251">if</span><!-- react-text: 252 --> (isObject(tagName)) {
        opts = tagName
        tagName = <!-- /react-text --><span class="hljs-number" data-reactid="253">0</span><!-- react-text: 254 -->
    }
    <!-- /react-text --><span class="hljs-keyword" data-reactid="255">if</span><!-- react-text: 256 --> (isString(selector)) {
        selector = selector === <!-- /react-text --><span class="hljs-string" data-reactid="257">&#x27;*&#x27;</span><!-- react-text: 258 --> ?
            allTags = selectTags() :
            selector + selectTags(selector.split(<!-- /react-text --><span class="hljs-regexp" data-reactid="259">/, */</span><!-- react-text: 260 -->))
        <!-- /react-text --><span class="hljs-comment" data-reactid="261">// ③ 利用 $$ 来判断 这些 tag 是否已经挂载在 html 上面</span><!-- react-text: 262 -->
        elem = selector ? $$(selector) : []
    } <!-- /react-text --><span class="hljs-keyword" data-reactid="263">else</span><!-- react-text: 264 -->
        elem = selector
    <!-- /react-text --><span class="hljs-comment" data-reactid="265">// 将所有元素挂载在根元素中</span><!-- react-text: 266 -->
    <!-- /react-text --><span class="hljs-keyword" data-reactid="267">if</span><!-- react-text: 268 --> (tagName === <!-- /react-text --><span class="hljs-string" data-reactid="269">&#x27;*&#x27;</span><!-- react-text: 270 -->) {
        tagName = allTags || selectTags()
        <!-- /react-text --><span class="hljs-keyword" data-reactid="271">if</span><!-- react-text: 272 --> (elem.tagName)
            <!-- /react-text --><span class="hljs-comment" data-reactid="273">// 查找elem下的 tagName</span><!-- react-text: 274 -->
            elem = $$(tagName, elem)
        <!-- /react-text --><span class="hljs-keyword" data-reactid="275">else</span><!-- react-text: 276 --> {
            <!-- /react-text --><span class="hljs-comment" data-reactid="277">// 将查找到的所有节点都 放入 nodeList中</span><!-- react-text: 278 -->
            <!-- /react-text --><span class="hljs-keyword" data-reactid="279">var</span><!-- react-text: 280 --> nodeList = []
            each(elem, _el =&gt; nodeList.push($$(tagName, _el)))
            elem = nodeList
        }
        tagName = <!-- /react-text --><span class="hljs-number" data-reactid="281">0</span><!-- react-text: 282 -->
    }
    pushTagsTo(elem)
    <!-- /react-text --><span class="hljs-keyword" data-reactid="283">return</span><!-- react-text: 284 --> tags
}     <!-- /react-text --></code></pre><p data-reactid="285"><!-- react-text: 286 -->当调用 riot.mount 后，通过 selector 参数来查找 html 页面上对应的节点。<!-- /react-text --><code data-reactid="287">不在 html 上的节点是不会被渲染的</code><!-- react-text: 288 -->。③处代码为查找过程，其中$$为 <!-- /react-text --><code data-reactid="289">document.querySelectAll</code><!-- react-text: 290 -->。之后调用 pushTagsTo 函数来渲染 riot tag。<!-- /react-text --><br data-reactid="291"/><code data-reactid="292">IS_DIRECTIVE = &#x27;data-is&#x27;</code><!-- react-text: 293 --> 渲染前，要检查是否含有 tagName 参数，如果有的话即为 上述 riot.mount 的第三个用法。此时需要检测 root 的 data-is 属性值是否和 tagName 相等，如①处。不相等则将 root 设置其 data-is 为 tagName。<!-- /react-text --></p><h3 id="取消注册-riotunregister" data-reactid="294"><a href="#%E5%8F%96%E6%B6%88%E6%B3%A8%E5%86%8C-riotunregister" aria-hidden="true" data-reactid="295"><span class="icon icon-link" data-reactid="296"></span></a><!-- react-text: 297 -->取消注册 riot.unregister()<!-- /react-text --></h3><p data-reactid="298">riot.unregister() 源码十分简单，如下：</p><pre data-reactid="299"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="300"><span class="hljs-keyword" data-reactid="301">export</span><!-- react-text: 302 --> <!-- /react-text --><span class="hljs-function" data-reactid="303"><span class="hljs-keyword" data-reactid="304">function</span><!-- react-text: 305 --> <!-- /react-text --><span class="hljs-title" data-reactid="306">unregister</span><!-- react-text: 307 -->(<!-- /react-text --><span class="hljs-params" data-reactid="308">name</span><!-- react-text: 309 -->) <!-- /react-text --></span><!-- react-text: 310 -->{
    __TAG_IMPL[name] = <!-- /react-text --><span class="hljs-literal" data-reactid="311">null</span><!-- react-text: 312 -->
}<!-- /react-text --></code></pre><h2 id="riotjs-组件" data-reactid="313"><a href="#riotjs-%E7%BB%84%E4%BB%B6" aria-hidden="true" data-reactid="314"><span class="icon icon-link" data-reactid="315"></span></a><!-- react-text: 316 -->Riot.js 组件<!-- /react-text --></h2><p data-reactid="317"><!-- react-text: 318 -->在 Riot.js 中，每个自定义标签都可以看成是一个组件，每个组件其实本质上都是一个 <!-- /react-text --><code data-reactid="319">Tag</code><!-- react-text: 320 --> 对象, 里面包含了对象的各种属性和方法<!-- /react-text --></p><h3 id="tag-类" data-reactid="321"><a href="#tag-%E7%B1%BB" aria-hidden="true" data-reactid="322"><span class="icon icon-link" data-reactid="323"></span></a><!-- react-text: 324 -->Tag 类<!-- /react-text --></h3><p data-reactid="325"><code data-reactid="326">Tag</code><!-- react-text: 327 --> 类简化源代码如下：<!-- /react-text --></p><pre data-reactid="328"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="329"><span class="hljs-comment" data-reactid="330">// impl 包含组件的模板，逻辑等属性  </span><!-- react-text: 331 -->
<!-- /react-text --><span class="hljs-keyword" data-reactid="332">export</span><!-- react-text: 333 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="334">default</span><!-- react-text: 335 --> <!-- /react-text --><span class="hljs-function" data-reactid="336"><span class="hljs-keyword" data-reactid="337">function</span><!-- react-text: 338 --> <!-- /react-text --><span class="hljs-title" data-reactid="339">Tag</span><!-- react-text: 340 -->(<!-- /react-text --><span class="hljs-params" data-reactid="341">impl = {}, conf = {}, innerHTML</span><!-- react-text: 342 -->) <!-- /react-text --></span><!-- react-text: 343 -->{
    ...各种属性初始化
    defineProperty(<!-- /react-text --><span class="hljs-keyword" data-reactid="344">this</span><!-- react-text: 345 -->, <!-- /react-text --><span class="hljs-string" data-reactid="346">&#x27;__&#x27;</span><!-- react-text: 347 -->, {...})
    defineProperty(<!-- /react-text --><span class="hljs-keyword" data-reactid="348">this</span><!-- react-text: 349 -->, <!-- /react-text --><span class="hljs-string" data-reactid="350">&#x27;_riot_id&#x27;</span><!-- react-text: 351 -->, ++__uid)
    defineProperty(<!-- /react-text --><span class="hljs-keyword" data-reactid="352">this</span><!-- react-text: 353 -->, <!-- /react-text --><span class="hljs-string" data-reactid="354">&#x27;refs&#x27;</span><!-- react-text: 355 -->, {})
    ...
    <!-- /react-text --><span class="hljs-comment" data-reactid="356">// 定义组件更新方法</span><!-- react-text: 357 -->
    defineProperty(<!-- /react-text --><span class="hljs-keyword" data-reactid="358">this</span><!-- react-text: 359 -->, <!-- /react-text --><span class="hljs-string" data-reactid="360">&#x27;update&#x27;</span><!-- react-text: 361 -->, <!-- /react-text --><span class="hljs-function" data-reactid="362"><span class="hljs-keyword" data-reactid="363">function</span><!-- react-text: 364 --> <!-- /react-text --><span class="hljs-title" data-reactid="365">tagUpdate</span><!-- react-text: 366 -->(<!-- /react-text --><span class="hljs-params" data-reactid="367">data</span><!-- react-text: 368 -->)<!-- /react-text --></span><!-- react-text: 369 -->{...}.bind(<!-- /react-text --><span class="hljs-keyword" data-reactid="370">this</span><!-- react-text: 371 -->))
    <!-- /react-text --><span class="hljs-comment" data-reactid="372">// 定义组件 mixin 方法</span><!-- react-text: 373 -->
    defineProperty(<!-- /react-text --><span class="hljs-keyword" data-reactid="374">this</span><!-- react-text: 375 -->, <!-- /react-text --><span class="hljs-string" data-reactid="376">&#x27;update&#x27;</span><!-- react-text: 377 -->, <!-- /react-text --><span class="hljs-function" data-reactid="378"><span class="hljs-keyword" data-reactid="379">function</span><!-- react-text: 380 --> <!-- /react-text --><span class="hljs-title" data-reactid="381">tagMixin</span><!-- react-text: 382 -->(<!-- /react-text --><span class="hljs-params" data-reactid="383">data</span><!-- react-text: 384 -->)<!-- /react-text --></span><!-- react-text: 385 -->{...}.bind(<!-- /react-text --><span class="hljs-keyword" data-reactid="386">this</span><!-- react-text: 387 -->))
    <!-- /react-text --><span class="hljs-comment" data-reactid="388">// 定义组件加载方法</span><!-- react-text: 389 -->
    defineProperty(<!-- /react-text --><span class="hljs-keyword" data-reactid="390">this</span><!-- react-text: 391 -->, <!-- /react-text --><span class="hljs-string" data-reactid="392">&#x27;mount&#x27;</span><!-- react-text: 393 -->, <!-- /react-text --><span class="hljs-function" data-reactid="394"><span class="hljs-keyword" data-reactid="395">function</span><!-- react-text: 396 --> <!-- /react-text --><span class="hljs-title" data-reactid="397">tagMount</span><!-- react-text: 398 -->(<!-- /react-text --><span class="hljs-params" data-reactid="399">data</span><!-- react-text: 400 -->)<!-- /react-text --></span><!-- react-text: 401 -->{...}.bind(<!-- /react-text --><span class="hljs-keyword" data-reactid="402">this</span><!-- react-text: 403 -->))
    <!-- /react-text --><span class="hljs-comment" data-reactid="404">// 定义组件卸载方法</span><!-- react-text: 405 -->
    defineProperty(<!-- /react-text --><span class="hljs-keyword" data-reactid="406">this</span><!-- react-text: 407 -->, <!-- /react-text --><span class="hljs-string" data-reactid="408">&#x27;mount&#x27;</span><!-- react-text: 409 -->, <!-- /react-text --><span class="hljs-function" data-reactid="410"><span class="hljs-keyword" data-reactid="411">function</span><!-- react-text: 412 --> <!-- /react-text --><span class="hljs-title" data-reactid="413">tagUnmount</span><!-- react-text: 414 -->(<!-- /react-text --><span class="hljs-params" data-reactid="415">data</span><!-- react-text: 416 -->)<!-- /react-text --></span><!-- react-text: 417 -->{...}.bind(<!-- /react-text --><span class="hljs-keyword" data-reactid="418">this</span><!-- react-text: 419 -->))
}<!-- /react-text --></code></pre><h3 id="组件的生命周期" data-reactid="420"><a href="#%E7%BB%84%E4%BB%B6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F" aria-hidden="true" data-reactid="421"><span class="icon icon-link" data-reactid="422"></span></a><!-- react-text: 423 -->组件的生命周期<!-- /react-text --></h3><p data-reactid="424">riot 组件状态分为以下几个部分：</p><ul data-reactid="425"><li data-reactid="426">before-mount：标签被加载之前</li><li data-reactid="427">mount：标签实例被加载到页面上以后</li><li data-reactid="428">update：允许在更新之前重新计算上下文数据</li><li data-reactid="429">updated：标签模板更新后</li><li data-reactid="430">before-unmount：标签实例被卸载之前</li><li data-reactid="431">unmount：标签实例被从页面上卸载后</li></ul><img src="https://caelumtian.github.io/images/b.png" alt="alt" width="675" height="848" data-reactid="432"/><p data-reactid="433">riot.js 采用事件驱动的方式来进行通讯，我们可以采用如下函数来监听上面的事件，例如处理 update 事件：</p><pre data-reactid="434"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="435"><!-- react-text: 436 -->&lt;riot-demo&gt;
    <!-- /react-text --><span class="xml" data-reactid="437"><span class="hljs-tag" data-reactid="438"><!-- react-text: 439 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="440">script</span><!-- react-text: 441 -->&gt;<!-- /react-text --></span><span class="actionscript" data-reactid="442"><!-- react-text: 443 -->
        <!-- /react-text --><span class="hljs-keyword" data-reactid="444">this</span><!-- react-text: 445 -->.on(<!-- /react-text --><span class="hljs-string" data-reactid="446">&#x27;update&#x27;</span><!-- react-text: 447 -->, <!-- /react-text --><span class="hljs-function" data-reactid="448"><span class="hljs-keyword" data-reactid="449">function</span><span class="hljs-params" data-reactid="450">()</span><!-- react-text: 451 --> <!-- /react-text --></span><!-- react-text: 452 -->{
            <!-- /react-text --><span class="hljs-comment" data-reactid="453">// 标签更新后的处理</span><!-- react-text: 454 -->
        })
    <!-- /react-text --></span><span class="hljs-tag" data-reactid="455"><!-- react-text: 456 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="457">script</span><!-- react-text: 458 -->&gt;<!-- /react-text --></span></span><!-- react-text: 459 -->
&lt;<!-- /react-text --><span class="hljs-regexp" data-reactid="460">/riot-demo&gt;</span></code></pre><h3 id="再谈组件加载" data-reactid="461"><a href="#%E5%86%8D%E8%B0%88%E7%BB%84%E4%BB%B6%E5%8A%A0%E8%BD%BD" aria-hidden="true" data-reactid="462"><span class="icon icon-link" data-reactid="463"></span></a><!-- react-text: 464 -->再谈组件加载<!-- /react-text --></h3><p data-reactid="465"><!-- react-text: 466 -->当我们调用 riot.mount() 渲染指定组件的时候，riot 会从 <!-- /react-text --><code data-reactid="467">__TAG_IMPL</code><!-- react-text: 468 --> 中获取相对应的已经注册好的模板内容，并生成相应的 Tag 实例对象。并且触发其上的 Tag.mount() 函数，最后将 Tag 对象缓存到 <!-- /react-text --><code data-reactid="469">__TAGS_CACHE</code><!-- react-text: 470 --> 中。代码如下：<!-- /react-text --></p><pre data-reactid="471"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="472"><span class="hljs-keyword" data-reactid="473">export</span><!-- react-text: 474 --> <!-- /react-text --><span class="hljs-function" data-reactid="475"><span class="hljs-keyword" data-reactid="476">function</span><!-- react-text: 477 --> <!-- /react-text --><span class="hljs-title" data-reactid="478">mountTo</span><!-- react-text: 479 -->(<!-- /react-text --><span class="hljs-params" data-reactid="480">root, tagName, opts, ctx</span><!-- react-text: 481 -->) <!-- /react-text --></span><!-- react-text: 482 -->{
    <!-- /react-text --><span class="hljs-keyword" data-reactid="483">var</span><!-- react-text: 484 --> impl = __TAG_IMPL[tagName],   <!-- /react-text --><span class="hljs-comment" data-reactid="485">// 获取 html 模板</span><!-- react-text: 486 -->
        implClass = __TAG_IMPL[tagName].class, <!-- /react-text --><span class="hljs-comment" data-reactid="487">// ?</span><!-- react-text: 488 -->
        tag = ctx || (implClass ? <!-- /react-text --><span class="hljs-built_in" data-reactid="489">Object</span><!-- react-text: 490 -->.create(implClass.prototype) : {}),
        innerHTML = root._innerHTML = root._innerHTML || root.innerHTML
    <!-- /react-text --><span class="hljs-keyword" data-reactid="491">var</span><!-- react-text: 492 --> conf = extend({
        <!-- /react-text --><span class="hljs-attr" data-reactid="493">root</span><!-- react-text: 494 -->: root,
        <!-- /react-text --><span class="hljs-attr" data-reactid="495">opts</span><!-- react-text: 496 -->: opts
    }, {
        <!-- /react-text --><span class="hljs-attr" data-reactid="497">parent</span><!-- react-text: 498 -->: opts ? opts.parent : <!-- /react-text --><span class="hljs-literal" data-reactid="499">null</span><!-- react-text: 500 -->
    })
    <!-- /react-text --><span class="hljs-keyword" data-reactid="501">if</span><!-- react-text: 502 --> (impl &amp;&amp; root) Tag.apply(tag, [impl, conf, innerHTML]);
    <!-- /react-text --><span class="hljs-keyword" data-reactid="503">if</span><!-- react-text: 504 --> (tag &amp;&amp; tag.mount) {
        tag.mount(<!-- /react-text --><span class="hljs-literal" data-reactid="505">true</span><!-- react-text: 506 -->)
        <!-- /react-text --><span class="hljs-comment" data-reactid="507">// add this tag to the virtualDom variable</span><!-- react-text: 508 -->
        <!-- /react-text --><span class="hljs-keyword" data-reactid="509">if</span><!-- react-text: 510 --> (!contains(__TAGS_CACHE, tag)) __TAGS_CACHE.push(tag)
    }
    <!-- /react-text --><span class="hljs-keyword" data-reactid="511">return</span><!-- react-text: 512 --> tag
}<!-- /react-text --></code></pre><p data-reactid="513">组件加载阶段，首先会整理标签上所有的 attribute 的内容，区分普通属性，和带有表达式 expr 的属性。</p><pre data-reactid="514"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="515"><!-- react-text: 516 -->defineProperty(<!-- /react-text --><span class="hljs-keyword" data-reactid="517">this</span><!-- react-text: 518 -->, <!-- /react-text --><span class="hljs-string" data-reactid="519">&#x27;mount&#x27;</span><!-- react-text: 520 -->, <!-- /react-text --><span class="hljs-function" data-reactid="521"><span class="hljs-keyword" data-reactid="522">function</span><!-- react-text: 523 --> <!-- /react-text --><span class="hljs-title" data-reactid="524">tagMount</span><!-- react-text: 525 -->(<!-- /react-text --><span class="hljs-params" data-reactid="526"></span><!-- react-text: 527 -->) <!-- /react-text --></span><!-- react-text: 528 -->{
    ...
    parseAttributes.apply(parent, [root, root.attributes, (attr, expr) =&gt; {
        <!-- /react-text --><span class="hljs-comment" data-reactid="529">// 检测 expr 是否在 RefExpr 的原型链中</span><!-- react-text: 530 -->
        <!-- /react-text --><span class="hljs-keyword" data-reactid="531">if</span><!-- react-text: 532 --> (!isAnonymous &amp;&amp; RefExpr.isPrototypeOf(expr)) expr.tag = <!-- /react-text --><span class="hljs-keyword" data-reactid="533">this</span><!-- react-text: 534 -->;
        <!-- /react-text --><span class="hljs-comment" data-reactid="535">// 挂载在 root.attributs 上面 root 为组件所在的 dom 对象</span><!-- react-text: 536 -->
        attr.expr = expr
        instAttrs.push(attr)
    }])   
    <!-- /react-text --><span class="hljs-comment" data-reactid="537">// impl 对象包含组件上的各种属性，包括模板，逻辑等内容</span><!-- react-text: 538 -->
    implAttrs = []
    walkAttrs(impl.attrs, (k, v) =&gt; {
        implAttrs.push({
            <!-- /react-text --><span class="hljs-attr" data-reactid="539">name</span><!-- react-text: 540 -->: k,
            <!-- /react-text --><span class="hljs-attr" data-reactid="541">value</span><!-- react-text: 542 -->: v
        })
    })
    <!-- /react-text --><span class="hljs-comment" data-reactid="543">// 检查的是 implAttrs</span><!-- react-text: 544 -->
    parseAttributes.apply(<!-- /react-text --><span class="hljs-keyword" data-reactid="545">this</span><!-- react-text: 546 -->, [root, implAttrs, (attr, expr) =&gt; {
        <!-- /react-text --><span class="hljs-keyword" data-reactid="547">if</span><!-- react-text: 548 --> (expr) expressions.push(expr)   <!-- /react-text --><span class="hljs-comment" data-reactid="549">//插入表达式</span><!-- react-text: 550 -->
        <!-- /react-text --><span class="hljs-keyword" data-reactid="551">else</span><!-- react-text: 552 --> setAttr(root, attr.name, attr.value)
    }])
    ... 
}).bind(<!-- /react-text --><span class="hljs-keyword" data-reactid="553">this</span><!-- react-text: 554 -->)<!-- /react-text --></code></pre><p data-reactid="555">初始化这些表达式内容，然后为组件添加全局注册的mixin 内容。接下来，会执行我们为组件添加的函数内容，此时触发 before-mount 事件。触发完毕后，解析标签上的表达式，比如 if each 等内容，然后执行组件的 update() 函数。</p><p data-reactid="556">在 update() 函数中，首先会检查用户是否定义了组件的 shouldUpdate() 函数，如果有定义则传入两个参数，第一个是想要更新的内容(即调用this.update() 时传入的参数)。第二个为接收的父组件更新的 opts 内容。若该函数返回值为 true 则更新渲染，否则放弃。 (这里需要注意，Tag.mount() 阶段由于组件尚未处于记载完毕状态，因此不会触发 shouldUpdate() 函数)。</p><pre data-reactid="557"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="558"><!-- react-text: 559 -->defineProperty(<!-- /react-text --><span class="hljs-keyword" data-reactid="560">this</span><!-- react-text: 561 -->, <!-- /react-text --><span class="hljs-string" data-reactid="562">&#x27;update&#x27;</span><!-- react-text: 563 -->, <!-- /react-text --><span class="hljs-function" data-reactid="564"><span class="hljs-keyword" data-reactid="565">function</span><!-- react-text: 566 --> <!-- /react-text --><span class="hljs-title" data-reactid="567">tagUpdate</span><!-- react-text: 568 -->(<!-- /react-text --><span class="hljs-params" data-reactid="569">data</span><!-- react-text: 570 -->) <!-- /react-text --></span><!-- react-text: 571 -->{
    ...
    <!-- /react-text --><span class="hljs-comment" data-reactid="572">// shouldUpdate 返回值检测</span><!-- react-text: 573 -->
    <!-- /react-text --><span class="hljs-keyword" data-reactid="574">if</span><!-- react-text: 575 --> (canTrigger &amp;&amp; <!-- /react-text --><span class="hljs-keyword" data-reactid="576">this</span><!-- react-text: 577 -->.isMounted &amp;&amp; isFunction(<!-- /react-text --><span class="hljs-keyword" data-reactid="578">this</span><!-- react-text: 579 -->.shouldUpdate) &amp;&amp; !<!-- /react-text --><span class="hljs-keyword" data-reactid="580">this</span><!-- react-text: 581 -->.shouldUpdate(data, nextOpts)) {
        <!-- /react-text --><span class="hljs-keyword" data-reactid="582">return</span><!-- react-text: 583 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="584">this</span><!-- react-text: 585 -->
    }
    ...
    <!-- /react-text --><span class="hljs-comment" data-reactid="586">// 扩展opts</span><!-- react-text: 587 -->
    extend(opts, nextOpts)
    <!-- /react-text --><span class="hljs-keyword" data-reactid="588">if</span><!-- react-text: 589 --> (canTrigger) <!-- /react-text --><span class="hljs-keyword" data-reactid="590">this</span><!-- react-text: 591 -->.trigger(<!-- /react-text --><span class="hljs-string" data-reactid="592">&#x27;update&#x27;</span><!-- react-text: 593 -->, data)
    update.call(<!-- /react-text --><span class="hljs-keyword" data-reactid="594">this</span><!-- react-text: 595 -->, expressions)
    <!-- /react-text --><span class="hljs-keyword" data-reactid="596">if</span><!-- react-text: 597 --> (canTrigger) <!-- /react-text --><span class="hljs-keyword" data-reactid="598">this</span><!-- react-text: 599 -->.trigger(<!-- /react-text --><span class="hljs-string" data-reactid="600">&#x27;updated&#x27;</span><!-- react-text: 601 -->)
    <!-- /react-text --><span class="hljs-keyword" data-reactid="602">return</span><!-- react-text: 603 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="604">this</span><!-- react-text: 605 -->
}).bind(<!-- /react-text --><span class="hljs-keyword" data-reactid="606">this</span><!-- react-text: 607 -->);<!-- /react-text --></code></pre><p data-reactid="608">之后会触发 update 事件，开始渲染新的组件。渲染完毕后触发 updated 事件。</p><p data-reactid="609">加载完毕后，修改组件状态 defineProperty(this, &#x27;isMounted&#x27;, true)。如果渲染的组件不是作为子组件的话，我们就触发自身的 mount 事件。否则的话，需要等到父组件加载完毕后，或者更新完毕后(已经加载过了)，再触发。</p><pre data-reactid="610"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="611"><!-- react-text: 612 -->defineProperty(<!-- /react-text --><span class="hljs-keyword" data-reactid="613">this</span><!-- react-text: 614 -->, <!-- /react-text --><span class="hljs-string" data-reactid="615">&#x27;mount&#x27;</span><!-- react-text: 616 -->, <!-- /react-text --><span class="hljs-function" data-reactid="617"><span class="hljs-keyword" data-reactid="618">function</span><!-- react-text: 619 --> <!-- /react-text --><span class="hljs-title" data-reactid="620">tagMount</span><!-- react-text: 621 -->(<!-- /react-text --><span class="hljs-params" data-reactid="622"></span><!-- react-text: 623 -->) <!-- /react-text --></span><!-- react-text: 624 -->{
    ...
    defineProperty(<!-- /react-text --><span class="hljs-keyword" data-reactid="625">this</span><!-- react-text: 626 -->, <!-- /react-text --><span class="hljs-string" data-reactid="627">&#x27;root&#x27;</span><!-- react-text: 628 -->, root)
    defineProperty(<!-- /react-text --><span class="hljs-keyword" data-reactid="629">this</span><!-- react-text: 630 -->, <!-- /react-text --><span class="hljs-string" data-reactid="631">&#x27;isMounted&#x27;</span><!-- react-text: 632 -->, <!-- /react-text --><span class="hljs-literal" data-reactid="633">true</span><!-- react-text: 634 -->)
    <!-- /react-text --><span class="hljs-keyword" data-reactid="635">if</span><!-- react-text: 636 --> (skipAnonymous) <!-- /react-text --><span class="hljs-keyword" data-reactid="637">return</span><!-- react-text: 638 -->
    <!-- /react-text --><span class="hljs-comment" data-reactid="639">// 如果不是子组件则触发</span><!-- react-text: 640 -->
    <!-- /react-text --><span class="hljs-keyword" data-reactid="641">if</span><!-- react-text: 642 --> (!<!-- /react-text --><span class="hljs-keyword" data-reactid="643">this</span><!-- react-text: 644 -->.parent) {
        <!-- /react-text --><span class="hljs-keyword" data-reactid="645">this</span><!-- react-text: 646 -->.trigger(<!-- /react-text --><span class="hljs-string" data-reactid="647">&#x27;mount&#x27;</span><!-- react-text: 648 -->)
    }
    <!-- /react-text --><span class="hljs-comment" data-reactid="649">// 否则需要等待父组件的状态渲染状态</span><!-- react-text: 650 -->
    <!-- /react-text --><span class="hljs-keyword" data-reactid="651">else</span><!-- react-text: 652 --> {
        <!-- /react-text --><span class="hljs-keyword" data-reactid="653">const</span><!-- react-text: 654 --> p = getImmediateCustomParentTag(<!-- /react-text --><span class="hljs-keyword" data-reactid="655">this</span><!-- react-text: 656 -->.parent)
        p.one(!p.isMounted ? <!-- /react-text --><span class="hljs-string" data-reactid="657">&#x27;mount&#x27;</span><!-- react-text: 658 --> : <!-- /react-text --><span class="hljs-string" data-reactid="659">&#x27;updated&#x27;</span><!-- react-text: 660 -->, () =&gt; {
            <!-- /react-text --><span class="hljs-keyword" data-reactid="661">this</span><!-- react-text: 662 -->.trigger(<!-- /react-text --><span class="hljs-string" data-reactid="663">&#x27;mount&#x27;</span><!-- react-text: 664 -->)
        })
    }
    <!-- /react-text --><span class="hljs-keyword" data-reactid="665">return</span><!-- react-text: 666 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="667">this</span><!-- react-text: 668 -->
}).bind(<!-- /react-text --><span class="hljs-keyword" data-reactid="669">this</span><!-- react-text: 670 -->) <!-- /react-text --></code></pre><p data-reactid="671">当我们调用 tag.unmount 卸载组件的时候，首先会触发 before-unmount 事件。再接下来清除所有的属性和事件监听等内容后，触发 ‘unmount’ 事件。</p><h2 id="组件更新原理" data-reactid="672"><a href="#%E7%BB%84%E4%BB%B6%E6%9B%B4%E6%96%B0%E5%8E%9F%E7%90%86" aria-hidden="true" data-reactid="673"><span class="icon icon-link" data-reactid="674"></span></a><!-- react-text: 675 -->组件更新原理<!-- /react-text --></h2><p data-reactid="676">在 riot.js 中，想要更新组件我们必须手动调用 tag.update() 方法才可以或者通过绑定 dom 事件触发(通过模板绑定的事件，会在回调执行完毕后自动触发 tag.update )，并不能做到实时的更新处理。例如：</p><pre data-reactid="677"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="678"><!-- react-text: 679 -->&lt;riot-demo&gt;
    <!-- /react-text --><span class="xml" data-reactid="680"><span class="hljs-tag" data-reactid="681"><!-- react-text: 682 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="683">h1</span><!-- react-text: 684 -->&gt;<!-- /react-text --></span><!-- react-text: 685 -->{ title }<!-- /react-text --><span class="hljs-tag" data-reactid="686"><!-- react-text: 687 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="688">h1</span><!-- react-text: 689 -->&gt;<!-- /react-text --></span></span><!-- react-text: 690 -->
    &lt;button click={ handleClick }&gt;修改内容&lt;<!-- /react-text --><span class="hljs-regexp" data-reactid="691">/button&gt;
    &lt;script&gt;
        this.title = &quot;标题&quot;
        handleClick() {
            this.title = &quot;新标题&quot;;
            this.update();   /</span><span class="hljs-regexp" data-reactid="692">/ 调用 update 方法才能重新渲染组件
        }
    &lt;/</span><!-- react-text: 693 -->script&gt;
<!-- /react-text --><span class="xml" data-reactid="694"><span class="hljs-tag" data-reactid="695"><!-- react-text: 696 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="697">riot-demo</span><!-- react-text: 698 -->&gt;<!-- /react-text --></span></span></code></pre><p data-reactid="699">riot.js 并没有提供 virtual dom 的功能，而是实现了一个粗粒度的 virtual dom。riot.js 为每个组件创建的 tag 对象中都保存一个 expressions 数组，更新的时候遍历 expressions 数组，对比旧值，如果有变化就更新DOM。这种更新机制类似angular的脏检查，但是仅有一轮检查（单项数据流）。更新处理依照模板类型来处理：</p><ul data-reactid="700"><li data-reactid="701">文本内容的，直接： dom.nodeValue = value</li><li data-reactid="702">值为空，而且关联的 DOM 属性是 checked/selected 等这种没有属性值的，移除对应的属性</li><li data-reactid="703">值为函数的，则进行事件绑定</li><li data-reactid="704">属性名为 if，则做条件判断处理</li><li data-reactid="705">做了 show/hide 的语法糖处理</li></ul><pre data-reactid="706"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="707"><span class="hljs-keyword" data-reactid="708">export</span><!-- react-text: 709 --> <!-- /react-text --><span class="hljs-function" data-reactid="710"><span class="hljs-keyword" data-reactid="711">function</span><!-- react-text: 712 --> <!-- /react-text --><span class="hljs-title" data-reactid="713">toggleVisibility</span><!-- react-text: 714 -->(<!-- /react-text --><span class="hljs-params" data-reactid="715">dom, show</span><!-- react-text: 716 -->) <!-- /react-text --></span><!-- react-text: 717 -->{
    dom.style.display = show ? <!-- /react-text --><span class="hljs-string" data-reactid="718">&#x27;&#x27;</span><!-- react-text: 719 --> : <!-- /react-text --><span class="hljs-string" data-reactid="720">&#x27;none&#x27;</span><!-- react-text: 721 -->
    dom[<!-- /react-text --><span class="hljs-string" data-reactid="722">&#x27;hidden&#x27;</span><!-- react-text: 723 -->] = show ? <!-- /react-text --><span class="hljs-literal" data-reactid="724">false</span><!-- react-text: 725 --> : <!-- /react-text --><span class="hljs-literal" data-reactid="726">true</span><!-- react-text: 727 -->
}<!-- /react-text --></code></pre><ul data-reactid="728"><li data-reactid="729">普通属性的，直接设置其值</li></ul><p data-reactid="730"><!-- react-text: 731 -->riot.js 和 react 一样也有 props(静态，riot 中为 opts) 和本身数据(动态)，具有和 react 一样的输入。但是输出的时候，由于没有 virtual dom UI的更新并没有集中处理，是分散的。<!-- /react-text --><br data-reactid="732"/><!-- react-text: 733 -->riot.js 采用的这种方式，代码量上大大的减少，但是也带来了比较严重的性能问题。<!-- /react-text --></p><h3 id="更新性能问题" data-reactid="734"><a href="#%E6%9B%B4%E6%96%B0%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98" aria-hidden="true" data-reactid="735"><span class="icon icon-link" data-reactid="736"></span></a><!-- react-text: 737 -->更新性能问题<!-- /react-text --></h3><p data-reactid="738">首先我们来看一段 vue 代码：</p><pre data-reactid="739"><code class="hljs language-html" data-query="{}" data-lang="html" data-reactid="740"><span class="hljs-tag" data-reactid="741"><!-- react-text: 742 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="743">div</span><!-- react-text: 744 --> <!-- /react-text --><span class="hljs-attr" data-reactid="745">id</span><!-- react-text: 746 -->=<!-- /react-text --><span class="hljs-string" data-reactid="747">&quot;demo&quot;</span><!-- react-text: 748 -->&gt;<!-- /react-text --></span><!-- react-text: 749 -->
    <!-- /react-text --><span class="hljs-tag" data-reactid="750"><!-- react-text: 751 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="752">ul</span><!-- react-text: 753 -->&gt;<!-- /react-text --></span><!-- react-text: 754 -->
        <!-- /react-text --><span class="hljs-tag" data-reactid="755"><!-- react-text: 756 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="757">li</span><!-- react-text: 758 --> <!-- /react-text --><span class="hljs-attr" data-reactid="759">v-for</span><!-- react-text: 760 -->=<!-- /react-text --><span class="hljs-string" data-reactid="761">&quot;item in items&quot;</span><!-- react-text: 762 -->&gt;<!-- /react-text --></span><!-- react-text: 763 -->
            {{ item.name }} --- {{ item.age }}
        <!-- /react-text --><span class="hljs-tag" data-reactid="764"><!-- react-text: 765 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="766">li</span><!-- react-text: 767 -->&gt;<!-- /react-text --></span><!-- react-text: 768 -->
    <!-- /react-text --><span class="hljs-tag" data-reactid="769"><!-- react-text: 770 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="771">ul</span><!-- react-text: 772 -->&gt;<!-- /react-text --></span><!-- react-text: 773 -->
    <!-- /react-text --><span class="hljs-tag" data-reactid="774"><!-- react-text: 775 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="776">button</span><!-- react-text: 777 --> <!-- /react-text --><span class="hljs-attr" data-reactid="778">v-on:click</span><!-- react-text: 779 -->=<!-- /react-text --><span class="hljs-string" data-reactid="780">&quot;handleClick&quot;</span><!-- react-text: 781 -->&gt;<!-- /react-text --></span><!-- react-text: 782 -->更新列表项<!-- /react-text --><span class="hljs-tag" data-reactid="783"><!-- react-text: 784 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="785">button</span><!-- react-text: 786 -->&gt;<!-- /react-text --></span><!-- react-text: 787 -->
<!-- /react-text --><span class="hljs-tag" data-reactid="788"><!-- react-text: 789 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="790">div</span><!-- react-text: 791 -->&gt;<!-- /react-text --></span><!-- react-text: 792 --> <!-- /react-text --></code></pre><pre data-reactid="793"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="794"><span class="hljs-keyword" data-reactid="795">var</span><!-- react-text: 796 --> demo = <!-- /react-text --><span class="hljs-keyword" data-reactid="797">new</span><!-- react-text: 798 --> Vue({
    <!-- /react-text --><span class="hljs-attr" data-reactid="799">el</span><!-- react-text: 800 -->: <!-- /react-text --><span class="hljs-string" data-reactid="801">&#x27;#demo&#x27;</span><!-- react-text: 802 -->,
    <!-- /react-text --><span class="hljs-attr" data-reactid="803">data</span><!-- react-text: 804 -->: {
        <!-- /react-text --><span class="hljs-attr" data-reactid="805">items</span><!-- react-text: 806 -->: [
          { <!-- /react-text --><span class="hljs-attr" data-reactid="807">name</span><!-- react-text: 808 -->: <!-- /react-text --><span class="hljs-string" data-reactid="809">&#x27;tgy&#x27;</span><!-- react-text: 810 -->, <!-- /react-text --><span class="hljs-attr" data-reactid="811">age</span><!-- react-text: 812 -->: <!-- /react-text --><span class="hljs-number" data-reactid="813">23</span><!-- react-text: 814 -->},
        ]
    },
    <!-- /react-text --><span class="hljs-attr" data-reactid="815">methods</span><!-- react-text: 816 -->: {
        <!-- /react-text --><span class="hljs-attr" data-reactid="817">handleClick</span><!-- react-text: 818 -->: <!-- /react-text --><span class="hljs-function" data-reactid="819"><span class="hljs-keyword" data-reactid="820">function</span><!-- react-text: 821 -->(<!-- /react-text --><span class="hljs-params" data-reactid="822"></span><!-- react-text: 823 -->) <!-- /react-text --></span><!-- react-text: 824 -->{
            <!-- /react-text --><span class="hljs-keyword" data-reactid="825">this</span><!-- react-text: 826 -->.items = [
                { <!-- /react-text --><span class="hljs-attr" data-reactid="827">name</span><!-- react-text: 828 -->: <!-- /react-text --><span class="hljs-string" data-reactid="829">&#x27;tgy&#x27;</span><!-- react-text: 830 -->, <!-- /react-text --><span class="hljs-attr" data-reactid="831">age</span><!-- react-text: 832 -->: <!-- /react-text --><span class="hljs-number" data-reactid="833">23</span><!-- react-text: 834 -->},
                { <!-- /react-text --><span class="hljs-attr" data-reactid="835">name</span><!-- react-text: 836 -->: <!-- /react-text --><span class="hljs-string" data-reactid="837">&#x27;hy&#x27;</span><!-- react-text: 838 -->, <!-- /react-text --><span class="hljs-attr" data-reactid="839">age</span><!-- react-text: 840 -->: <!-- /react-text --><span class="hljs-number" data-reactid="841">22</span><!-- react-text: 842 -->},
            ]
        }
    },
    <!-- /react-text --><span class="hljs-attr" data-reactid="843">mounted</span><!-- react-text: 844 -->: <!-- /react-text --><span class="hljs-function" data-reactid="845"><span class="hljs-keyword" data-reactid="846">function</span><!-- react-text: 847 -->(<!-- /react-text --><span class="hljs-params" data-reactid="848"></span><!-- react-text: 849 -->) <!-- /react-text --></span><!-- react-text: 850 -->{
         <!-- /react-text --><span class="hljs-built_in" data-reactid="851">console</span><!-- react-text: 852 -->.log(<!-- /react-text --><span class="hljs-string" data-reactid="853">&quot;组件挂载完毕&quot;</span><!-- react-text: 854 -->);
         <!-- /react-text --><span class="hljs-built_in" data-reactid="855">document</span><!-- react-text: 856 -->.querySelector(<!-- /react-text --><span class="hljs-string" data-reactid="857">&quot;li&quot;</span><!-- react-text: 858 -->).extraType = <!-- /react-text --><span class="hljs-string" data-reactid="859">&quot;origin&quot;</span><!-- react-text: 860 -->;
    },
    <!-- /react-text --><span class="hljs-attr" data-reactid="861">updated</span><!-- react-text: 862 -->: <!-- /react-text --><span class="hljs-function" data-reactid="863"><span class="hljs-keyword" data-reactid="864">function</span><!-- react-text: 865 -->(<!-- /react-text --><span class="hljs-params" data-reactid="866"></span><!-- react-text: 867 -->) <!-- /react-text --></span><!-- react-text: 868 -->{
         <!-- /react-text --><span class="hljs-built_in" data-reactid="869">console</span><!-- react-text: 870 -->.log(<!-- /react-text --><span class="hljs-string" data-reactid="871">&quot;组件更新完毕&quot;</span><!-- react-text: 872 -->);
         <!-- /react-text --><span class="hljs-built_in" data-reactid="873">console</span><!-- react-text: 874 -->.log(<!-- /react-text --><span class="hljs-built_in" data-reactid="875">document</span><!-- react-text: 876 -->.querySelector(<!-- /react-text --><span class="hljs-string" data-reactid="877">&quot;li&quot;</span><!-- react-text: 878 -->).extraType);
    }
}) <!-- /react-text --></code></pre><p data-reactid="879">代码很简单，单击按钮，为列表添加一条新数据。在组件挂载完毕后，为第一个 li 的 property 上面添加了 extraType 属性。列表更新后，再去访问这个 li 的 extraType 属性。运行结果如下：</p><img src="https://caelumtian.github.io/2017/10/18/riot-js%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%902/b.png" alt="alt" width="142" height="69" data-reactid="880"/><p data-reactid="881">不出意料，可以正常访问到 li 的type属性。这说明了，在更新过程中，第一个 li 节点仅仅是 textContent 发生了改变而不是重新创建的。这样的结果得益于 virtual dom 算法，保证更新最小变动。同样的我们用 riot 来重写上面的代码。</p><pre data-reactid="882"><code class="hljs language-html" data-query="{}" data-lang="html" data-reactid="883"><span class="hljs-tag" data-reactid="884"><!-- react-text: 885 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="886">content-demo</span><!-- react-text: 887 -->&gt;<!-- /react-text --></span><!-- react-text: 888 -->
   <!-- /react-text --><span class="hljs-tag" data-reactid="889"><!-- react-text: 890 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="891">ul</span><!-- react-text: 892 -->&gt;<!-- /react-text --></span><!-- react-text: 893 -->
      <!-- /react-text --><span class="hljs-tag" data-reactid="894"><!-- react-text: 895 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="896">li</span><!-- react-text: 897 --> <!-- /react-text --><span class="hljs-attr" data-reactid="898">each</span><!-- react-text: 899 -->=<!-- /react-text --><span class="hljs-string" data-reactid="900">{</span><!-- react-text: 901 --> <!-- /react-text --><span class="hljs-attr" data-reactid="902">items</span><!-- react-text: 903 --> }&gt;<!-- /react-text --></span><!-- react-text: 904 -->{ name } -- { age }<!-- /react-text --><span class="hljs-tag" data-reactid="905"><!-- react-text: 906 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="907">li</span><!-- react-text: 908 -->&gt;<!-- /react-text --></span><!-- react-text: 909 -->
   <!-- /react-text --><span class="hljs-tag" data-reactid="910"><!-- react-text: 911 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="912">ul</span><!-- react-text: 913 -->&gt;<!-- /react-text --></span><!-- react-text: 914 -->
   <!-- /react-text --><span class="hljs-tag" data-reactid="915"><!-- react-text: 916 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="917">button</span><!-- react-text: 918 --> <!-- /react-text --><span class="hljs-attr" data-reactid="919">class</span><!-- react-text: 920 -->=<!-- /react-text --><span class="hljs-string" data-reactid="921">&quot;btn&quot;</span><!-- react-text: 922 --> <!-- /react-text --><span class="hljs-attr" data-reactid="923">click</span><!-- react-text: 924 -->=<!-- /react-text --><span class="hljs-string" data-reactid="925">{</span><!-- react-text: 926 --> <!-- /react-text --><span class="hljs-attr" data-reactid="927">handleClick</span><!-- react-text: 928 --> }&gt;<!-- /react-text --></span><!-- react-text: 929 -->订阅内容<!-- /react-text --><span class="hljs-tag" data-reactid="930"><!-- react-text: 931 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="932">button</span><!-- react-text: 933 -->&gt;<!-- /react-text --></span><!-- react-text: 934 -->  
   <!-- /react-text --><span class="hljs-tag" data-reactid="935"><!-- react-text: 936 -->&lt;<!-- /react-text --><span class="hljs-name" data-reactid="937">script</span><!-- react-text: 938 -->&gt;<!-- /react-text --></span><span class="javascript" data-reactid="939"><!-- react-text: 940 -->
        <!-- /react-text --><span class="hljs-keyword" data-reactid="941">let</span><!-- react-text: 942 --> self = <!-- /react-text --><span class="hljs-keyword" data-reactid="943">this</span><!-- react-text: 944 -->;
        <!-- /react-text --><span class="hljs-keyword" data-reactid="945">this</span><!-- react-text: 946 -->.items = [
            {<!-- /react-text --><span class="hljs-string" data-reactid="947">&quot;name&quot;</span><!-- react-text: 948 -->: <!-- /react-text --><span class="hljs-string" data-reactid="949">&quot;tgy&quot;</span><!-- react-text: 950 -->, <!-- /react-text --><span class="hljs-attr" data-reactid="951">age</span><!-- react-text: 952 -->: <!-- /react-text --><span class="hljs-number" data-reactid="953">23</span><!-- react-text: 954 -->}
        ];
        handleClick() {
            <!-- /react-text --><span class="hljs-keyword" data-reactid="955">this</span><!-- react-text: 956 -->.items = [
                {<!-- /react-text --><span class="hljs-string" data-reactid="957">&quot;name&quot;</span><!-- react-text: 958 -->: <!-- /react-text --><span class="hljs-string" data-reactid="959">&quot;tgy&quot;</span><!-- react-text: 960 -->, <!-- /react-text --><span class="hljs-attr" data-reactid="961">age</span><!-- react-text: 962 -->: <!-- /react-text --><span class="hljs-number" data-reactid="963">23</span><!-- react-text: 964 -->},
                {<!-- /react-text --><span class="hljs-string" data-reactid="965">&quot;name&quot;</span><!-- react-text: 966 -->: <!-- /react-text --><span class="hljs-string" data-reactid="967">&quot;hy&quot;</span><!-- react-text: 968 -->, <!-- /react-text --><span class="hljs-attr" data-reactid="969">age</span><!-- react-text: 970 -->: <!-- /react-text --><span class="hljs-number" data-reactid="971">22</span><!-- react-text: 972 -->}
            ]
        }
        <!-- /react-text --><span class="hljs-keyword" data-reactid="973">this</span><!-- react-text: 974 -->.on(<!-- /react-text --><span class="hljs-string" data-reactid="975">&#x27;mount&#x27;</span><!-- react-text: 976 -->, <!-- /react-text --><span class="hljs-function" data-reactid="977"><span class="hljs-keyword" data-reactid="978">function</span><!-- react-text: 979 -->(<!-- /react-text --><span class="hljs-params" data-reactid="980"></span><!-- react-text: 981 -->) <!-- /react-text --></span><!-- react-text: 982 -->{
            <!-- /react-text --><span class="hljs-built_in" data-reactid="983">console</span><!-- react-text: 984 -->.log(<!-- /react-text --><span class="hljs-string" data-reactid="985">&quot;组件加载完毕&quot;</span><!-- react-text: 986 -->);
            <!-- /react-text --><span class="hljs-built_in" data-reactid="987">document</span><!-- react-text: 988 -->.querySelector(<!-- /react-text --><span class="hljs-string" data-reactid="989">&quot;li&quot;</span><!-- react-text: 990 -->).extraType = <!-- /react-text --><span class="hljs-string" data-reactid="991">&quot;origin&quot;</span><!-- react-text: 992 -->;
        })
        <!-- /react-text --><span class="hljs-keyword" data-reactid="993">this</span><!-- react-text: 994 -->.on(<!-- /react-text --><span class="hljs-string" data-reactid="995">&#x27;updated&#x27;</span><!-- react-text: 996 -->, <!-- /react-text --><span class="hljs-function" data-reactid="997"><span class="hljs-keyword" data-reactid="998">function</span><!-- react-text: 999 -->(<!-- /react-text --><span class="hljs-params" data-reactid="1000"></span><!-- react-text: 1001 -->) <!-- /react-text --></span><!-- react-text: 1002 -->{
            <!-- /react-text --><span class="hljs-built_in" data-reactid="1003">console</span><!-- react-text: 1004 -->.log(<!-- /react-text --><span class="hljs-string" data-reactid="1005">&quot;组件更新完毕&quot;</span><!-- react-text: 1006 -->);
            <!-- /react-text --><span class="hljs-built_in" data-reactid="1007">console</span><!-- react-text: 1008 -->.log(<!-- /react-text --><span class="hljs-built_in" data-reactid="1009">document</span><!-- react-text: 1010 -->.querySelector(<!-- /react-text --><span class="hljs-string" data-reactid="1011">&quot;li&quot;</span><!-- react-text: 1012 -->).extraType);
        })
   <!-- /react-text --></span><span class="hljs-tag" data-reactid="1013"><!-- react-text: 1014 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="1015">script</span><!-- react-text: 1016 -->&gt;<!-- /react-text --></span><!-- react-text: 1017 -->
<!-- /react-text --><span class="hljs-tag" data-reactid="1018"><!-- react-text: 1019 -->&lt;/<!-- /react-text --><span class="hljs-name" data-reactid="1020">content-demo</span><!-- react-text: 1021 -->&gt;<!-- /react-text --></span></code></pre><p data-reactid="1022">查看运行结果：</p><img src="https://caelumtian.github.io/2017/10/18/riot-js%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%902/c.png" alt="alt" width="165" height="66" data-reactid="1023"/><p data-reactid="1024">extraType 找不到了，所有的 li 节点都被重新构建了。这里面发生了什么，查看源码 /tag/each.js。渲染逻辑代码如下：</p><pre data-reactid="1025"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="1026"><span class="hljs-keyword" data-reactid="1027">export</span><!-- react-text: 1028 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="1029">default</span><!-- react-text: 1030 --> <!-- /react-text --><span class="hljs-function" data-reactid="1031"><span class="hljs-keyword" data-reactid="1032">function</span><!-- react-text: 1033 --> <!-- /react-text --><span class="hljs-title" data-reactid="1034">_each</span><!-- react-text: 1035 -->(<!-- /react-text --><span class="hljs-params" data-reactid="1036">dom, parent, expr</span><!-- react-text: 1037 -->) <!-- /react-text --></span><!-- react-text: 1038 -->{
    ...
    expr.update = <!-- /react-text --><span class="hljs-function" data-reactid="1039"><span class="hljs-keyword" data-reactid="1040">function</span><!-- react-text: 1041 --> <!-- /react-text --><span class="hljs-title" data-reactid="1042">updateEach</span><!-- react-text: 1043 -->(<!-- /react-text --><span class="hljs-params" data-reactid="1044"></span><!-- react-text: 1045 -->) <!-- /react-text --></span><!-- react-text: 1046 -->{
        ...
        each(items, <!-- /react-text --><span class="hljs-function" data-reactid="1047"><span class="hljs-keyword" data-reactid="1048">function</span><!-- react-text: 1049 --> (<!-- /react-text --><span class="hljs-params" data-reactid="1050">item, i</span><!-- react-text: 1051 -->) <!-- /react-text --></span><!-- react-text: 1052 -->{
            <!-- /react-text --><span class="hljs-comment" data-reactid="1053">// 仅仅记录 items 是对象的</span><!-- react-text: 1054 -->
            <!-- /react-text --><span class="hljs-keyword" data-reactid="1055">var</span><!-- react-text: 1056 -->
                doReorder = mustReorder &amp;&amp; <!-- /react-text --><span class="hljs-keyword" data-reactid="1057">typeof</span><!-- react-text: 1058 --> item === T_OBJECT &amp;&amp; !hasKeys,
                <!-- /react-text --><span class="hljs-comment" data-reactid="1059">// 旧数据</span><!-- react-text: 1060 -->
                oldPos = oldItems.indexOf(item),
                <!-- /react-text --><span class="hljs-comment" data-reactid="1061">// 是新的</span><!-- react-text: 1062 -->
                isNew = oldPos === <!-- /react-text --><span class="hljs-number" data-reactid="1063">-1</span><!-- react-text: 1064 -->,
                pos = !isNew &amp;&amp; doReorder ? oldPos : i,
                tag = tags[pos],
                <!-- /react-text --><span class="hljs-comment" data-reactid="1065">// 必须追加</span><!-- react-text: 1066 -->
                mustAppend = i &gt;= oldItems.length,
                <!-- /react-text --><span class="hljs-comment" data-reactid="1067">// 必须创建 isNew</span><!-- react-text: 1068 -->
                mustCreate = doReorder &amp;&amp; isNew || !doReorder &amp;&amp; !tag
                <!-- /react-text --><span class="hljs-comment" data-reactid="1069">// 有key值得时候需要 mkitem</span><!-- react-text: 1070 -->
            item = !hasKeys &amp;&amp; expr.key ? mkitem(expr, item, i) : item
            <!-- /react-text --><span class="hljs-comment" data-reactid="1071">// 必须创建一个新 tag </span><!-- react-text: 1072 -->
            <!-- /react-text --><span class="hljs-keyword" data-reactid="1073">if</span><!-- react-text: 1074 --> (mustCreate) {
                tag = <!-- /react-text --><span class="hljs-keyword" data-reactid="1075">new</span><!-- react-text: 1076 --> Tag(impl, {
                    parent,
                    isLoop,
                    isAnonymous,
                    tagName,
                    <!-- /react-text --><span class="hljs-attr" data-reactid="1077">root</span><!-- react-text: 1078 -->: dom.cloneNode(isAnonymous),
                    item,
                    <!-- /react-text --><span class="hljs-attr" data-reactid="1079">index</span><!-- react-text: 1080 -->: i,
                }, dom.innerHTML)

                <!-- /react-text --><span class="hljs-comment" data-reactid="1081">// mount the tag</span><!-- react-text: 1082 -->
                tag.mount()
                <!-- /react-text --><span class="hljs-keyword" data-reactid="1083">if</span><!-- react-text: 1084 --> (mustAppend)
                    append.apply(tag, [frag || root, isVirtual])
                <!-- /react-text --><span class="hljs-keyword" data-reactid="1085">else</span><!-- react-text: 1086 -->
                    insert.apply(tag, [root, tags[i], isVirtual])

                <!-- /react-text --><span class="hljs-keyword" data-reactid="1087">if</span><!-- react-text: 1088 --> (!mustAppend) oldItems.splice(i, <!-- /react-text --><span class="hljs-number" data-reactid="1089">0</span><!-- react-text: 1090 -->, item)
                tags.splice(i, <!-- /react-text --><span class="hljs-number" data-reactid="1091">0</span><!-- react-text: 1092 -->, tag)
                <!-- /react-text --><span class="hljs-keyword" data-reactid="1093">if</span><!-- react-text: 1094 --> (child) arrayishAdd(parent.tags, tagName, tag, <!-- /react-text --><span class="hljs-literal" data-reactid="1095">true</span><!-- react-text: 1096 -->)
            } <!-- /react-text --><span class="hljs-keyword" data-reactid="1097">else</span><!-- react-text: 1098 --> <!-- /react-text --><span class="hljs-keyword" data-reactid="1099">if</span><!-- react-text: 1100 --> (pos !== i &amp;&amp; doReorder) {
                <!-- /react-text --><span class="hljs-comment" data-reactid="1101">// move</span><!-- react-text: 1102 -->
                <!-- /react-text --><span class="hljs-comment" data-reactid="1103">// 移动</span><!-- react-text: 1104 -->
                <!-- /react-text --><span class="hljs-keyword" data-reactid="1105">if</span><!-- react-text: 1106 --> (contains(items, oldItems[pos])) {
                    move.apply(tag, [root, tags[i], isVirtual])
                    <!-- /react-text --><span class="hljs-comment" data-reactid="1107">// move the old tag instance</span><!-- react-text: 1108 -->
                    tags.splice(i, <!-- /react-text --><span class="hljs-number" data-reactid="1109">0</span><!-- react-text: 1110 -->, tags.splice(pos, <!-- /react-text --><span class="hljs-number" data-reactid="1111">1</span><!-- react-text: 1112 -->)[<!-- /react-text --><span class="hljs-number" data-reactid="1113">0</span><!-- react-text: 1114 -->])
                    <!-- /react-text --><span class="hljs-comment" data-reactid="1115">// move the old item</span><!-- react-text: 1116 -->
                    oldItems.splice(i, <!-- /react-text --><span class="hljs-number" data-reactid="1117">0</span><!-- react-text: 1118 -->, oldItems.splice(pos, <!-- /react-text --><span class="hljs-number" data-reactid="1119">1</span><!-- react-text: 1120 -->)[<!-- /react-text --><span class="hljs-number" data-reactid="1121">0</span><!-- react-text: 1122 -->])
                }
                <!-- /react-text --><span class="hljs-keyword" data-reactid="1123">if</span><!-- react-text: 1124 --> (expr.pos) tag[expr.pos] = i
                <!-- /react-text --><span class="hljs-keyword" data-reactid="1125">if</span><!-- react-text: 1126 --> (!child &amp;&amp; tag.tags) moveNestedTags.call(tag, i)
            }
            <!-- /react-text --><span class="hljs-comment" data-reactid="1127">// 缓存原始数据到节点上</span><!-- react-text: 1128 -->
            tag.__.item = item
            tag.__.index = i
            tag.__.parent = parent;
            <!-- /react-text --><span class="hljs-comment" data-reactid="1129">// 如果不是创建的，我们需要更新节点内容。</span><!-- react-text: 1130 -->
            <!-- /react-text --><span class="hljs-keyword" data-reactid="1131">if</span><!-- react-text: 1132 --> (!mustCreate) tag.update(item)
        })
        <!-- /react-text --><span class="hljs-comment" data-reactid="1133">// remove the redundant tags</span><!-- react-text: 1134 -->
        <!-- /react-text --><span class="hljs-comment" data-reactid="1135">// 删除多余的标签</span><!-- react-text: 1136 -->
        unmountRedundant(items, tags)
        <!-- /react-text --><span class="hljs-comment" data-reactid="1137">// 记录旧的数据</span><!-- react-text: 1138 -->
        <!-- /react-text --><span class="hljs-comment" data-reactid="1139">// clone the items array</span><!-- react-text: 1140 -->
        oldItems = items.slice()
        <!-- /react-text --><span class="hljs-comment" data-reactid="1141">// dom 插入节点</span><!-- react-text: 1142 -->
        root.insertBefore(frag, placeholder)
    }
}  <!-- /react-text --></code></pre><p data-reactid="1143">这段为列表渲染逻辑，遍历新的数据items中的每一下 item。在原始数据 oldItems 中去查找(oldItems.indexOf(itemId))，是否存在 item 项。如果不存在，则标记 isNews 为 true。之后走到 if 的 mustCreaete 为 true 的分支，去创建一个新的 tag(将 li 节点看成是一个tag)。以此类推，当全部创建完毕后，删除旧的节点(unmountRedundant(items, tags))。在断点下，可以清楚看到节点的变化情况：</p><img src="https://caelumtian.github.io/2017/10/18/riot-js%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%902/d.gif" alt="alt" width="178" height="72" data-reactid="1144"/><h3 id="优化更新" data-reactid="1145"><a href="#%E4%BC%98%E5%8C%96%E6%9B%B4%E6%96%B0" aria-hidden="true" data-reactid="1146"><span class="icon icon-link" data-reactid="1147"></span></a><!-- react-text: 1148 -->优化更新<!-- /react-text --></h3><p data-reactid="1149"><!-- react-text: 1150 -->综上所述，riot.js 的更新逻辑仅仅是判断新旧数据项是否为同一对象。为此，为了减少 DOM 的变动，降低渲染逻辑。我们修改<!-- /react-text --><code data-reactid="1151">handleClick</code><!-- react-text: 1152 -->函数：<!-- /react-text --></p><pre data-reactid="1153"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="1154"><!-- react-text: 1155 -->handleClick() {
    <!-- /react-text --><span class="hljs-keyword" data-reactid="1156">this</span><!-- react-text: 1157 -->.items.push({<!-- /react-text --><span class="hljs-string" data-reactid="1158">&quot;name&quot;</span><!-- react-text: 1159 -->: <!-- /react-text --><span class="hljs-string" data-reactid="1160">&quot;hy&quot;</span><!-- react-text: 1161 -->, <!-- /react-text --><span class="hljs-attr" data-reactid="1162">age</span><!-- react-text: 1163 -->: <!-- /react-text --><span class="hljs-number" data-reactid="1164">22</span><!-- react-text: 1165 -->})
} <!-- /react-text --></code></pre><p data-reactid="1166"><!-- react-text: 1167 -->这样输出结果就会和 vue 的保持一致，并没有创建新的 tag，而是利用了已经存在的内容。源码中，这种情况下 isNews 为 false，从而避开了 创建标签。而仅仅是通过 <!-- /react-text --><code data-reactid="1168">tags.splice(i, 0, tags.splice(pos, 1)[0]);</code><!-- react-text: 1169 --> 来移动位置，<!-- /react-text --><code data-reactid="1170">if (!mustCreate) { tag.update(item); }</code><!-- react-text: 1171 --> 更新节点内容。<!-- /react-text --><br data-reactid="1172"/><!-- react-text: 1173 -->保证数据项对象地址不变，仅仅是修改上面的不可变对象的值，将大大的提高 riot.js 的渲染效率。<!-- /react-text --></p><pre data-reactid="1174"><code class="hljs language-javascript" data-query="{}" data-lang="javascript" data-reactid="1175"><span class="hljs-comment" data-reactid="1176">// 更新第一个li内容  </span><!-- react-text: 1177 -->

<!-- /react-text --><span class="hljs-comment" data-reactid="1178">// 不推荐写法，对象发生变化；</span><!-- react-text: 1179 -->
<!-- /react-text --><span class="hljs-keyword" data-reactid="1180">this</span><!-- react-text: 1181 -->.items[<!-- /react-text --><span class="hljs-number" data-reactid="1182">0</span><!-- react-text: 1183 -->] = {<!-- /react-text --><span class="hljs-string" data-reactid="1184">&quot;name&quot;</span><!-- react-text: 1185 -->: <!-- /react-text --><span class="hljs-string" data-reactid="1186">&quot;hy&quot;</span><!-- react-text: 1187 -->, <!-- /react-text --><span class="hljs-attr" data-reactid="1188">age</span><!-- react-text: 1189 -->: <!-- /react-text --><span class="hljs-number" data-reactid="1190">23</span><!-- react-text: 1191 -->};   

<!-- /react-text --><span class="hljs-comment" data-reactid="1192">// 推荐写法，仅仅是修改对象中的值</span><!-- react-text: 1193 -->
<!-- /react-text --><span class="hljs-keyword" data-reactid="1194">this</span><!-- react-text: 1195 -->.items[<!-- /react-text --><span class="hljs-number" data-reactid="1196">0</span><!-- react-text: 1197 -->].name = <!-- /react-text --><span class="hljs-string" data-reactid="1198">&quot;hy&quot;</span><!-- react-text: 1199 -->;
<!-- /react-text --><span class="hljs-keyword" data-reactid="1200">this</span><!-- react-text: 1201 -->.items[<!-- /react-text --><span class="hljs-number" data-reactid="1202">0</span><!-- react-text: 1203 -->].age = <!-- /react-text --><span class="hljs-number" data-reactid="1204">22</span><!-- react-text: 1205 -->;<!-- /react-text --></code></pre><p data-reactid="1206"><!-- react-text: 1207 -->保证源数据对象的不变，仅仅改变其上面的值，这样就能减少 riot.js 渲染过程中，创建新的 <!-- /react-text --><code data-reactid="1208">tag</code><!-- react-text: 1209 --> 对象的开销。<!-- /react-text --></p><h1 id="参考资料" data-reactid="1210"><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" aria-hidden="true" data-reactid="1211"><span class="icon icon-link" data-reactid="1212"></span></a><!-- react-text: 1213 -->参考资料<!-- /react-text --></h1><ul data-reactid="1214"><li data-reactid="1215"><a href="https://techblog.toutiao.com/2016/12/13/riotjs/" data-reactid="1216">头条PC站基于RIOT的组件化开发实践</a></li><li data-reactid="1217"><a href="http://imweb.io/topic/573e766f1156025b1dce9404" data-reactid="1218">深入探讨前端UI框架</a></li><li data-reactid="1219"><a href="https://gist.github.com/teabyii/7f6bddf5934915081c5d" data-reactid="1220">Riot 源码阅读笔记</a></li><li data-reactid="1221"><a href="https://github.com/riot/riot/blob/7fe907d161731568c4d7755ab05493ddec12c6fd/lib/browser/tag" data-reactid="1222">Riot.js 源代码</a></li><li data-reactid="1223"><a href="http://www.ruanyifeng.com/blog/2015/02/mvcmvp_mvvm.html" data-reactid="1224">MVC，MVP 和 MVVM 的图示</a></li></ul></article><div data-reactid="1225"></div><nav class="single-bar clearfix" data-reactid="1226"><span class="prev" data-reactid="1227"><a rel="prev" href="/blog/fe/关于js中的浮点运算" data-reactid="1228"><em class="eux-icon eux-icon-page-prev" data-reactid="1229"></em><!-- react-text: 1230 -->关于 js 中的浮点计算<!-- /react-text --></a></span><span class="next" data-reactid="1231"><a rel="next" href="/blog/fe/如何进行edm邮件制作" data-reactid="1232"><em class="eux-icon eux-icon-page-next" data-reactid="1233"></em><!-- react-text: 1234 -->如何进行EDM邮件制作<!-- /react-text --></a></span></nav></div></div></div><footer class="footer" data-reactid="1235"><div class="eux-footer-area-wrapper container-singular" role="complementary" data-reactid="1236"><div class="inner clearfix" data-reactid="1237"><aside id="simple-links-2" class="widget sl-links-main" data-reactid="1238"><h2 class="widgettitle" data-reactid="1239">友情链接</h2><ul class="simple-links-list simple-links-2-list" id="simple-links-2-list" data-reactid="1240"><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="1241"><a target="_blank" href="http://sux.baidu.com/" title="百度 FEX 团队" data-reactid="1242">百度 FEX</a></li><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="1243"><a target="_blank" href="http://efe.baidu.com/" title="百度 EFE 团队" data-reactid="1244">百度 EFE</a></li><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="1245"><a target="_blank" href="http://sux.baidu.com/" title="百度 SUX 团队" data-reactid="1246">百度 SUX</a></li><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="1247"><a target="_blank" href="https://aotu.io/" title="京东凹凸实验室，面向多终端技术体系，致力于构建沉淀与分享包括但不限于交互、页面制作技巧、前端开发、原生APP开发等方面的专业知识及案例。" data-reactid="1248">凹凸实验室</a></li><li class="simple-links-item simple-links-widget-item" id="link-379" data-reactid="1249"><a target="_blank" href="https://fed.renren.com/" title="人人网FED" data-reactid="1250">人人网FED</a></li></ul></aside></div></div><div class="eux-icp" data-reactid="1251"><!-- react-text: 1252 -->百度EUX 版权所有 ©百度EUX    All rights reserved. 骄傲地采用 <!-- /react-text --><a target="_blank" href="https://github.com/picidaejs/picidaejs" data-reactid="1253">Picidae</a><!-- react-text: 1254 -->。<!-- /react-text --></div></footer></div>
</div>
<script src="/PICIDAE_COMMON.js"></script>
<script src="/PICIDAE_ENTRY.js"></script>
</body>
</html>